<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>coffee shop chatrooms</title>
    <!-- Favicon updated to a direct message bubble icon PNG -->
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3298/3298521.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"></link>
    <style>
        /* custom css for scrollbar and body margin */
        body { margin: 0; }
        .font-inter { font-family: 'Inter', sans-serif; }
        /* Light scrollbar (default) */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #e7e5e4; /* stone-200 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #a8a29e; /* stone-400 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #78716c; /* stone-600 */
        }

        /* Dark scrollbar (for custom dark themes) */
        .dark-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .dark-scrollbar::-webkit-scrollbar-track {
            background: #3f3f46; /* stone-700 */
            border-radius: 10px;
        }
        .dark-scrollbar::-webkit-scrollbar-thumb {
            background: #52525b; /* stone-600 */
            border-radius: 10px;
        }
        .dark-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #71717a; /* stone-500 */
        }

        /* New scrollbar for custom themes using CSS variables */
        .accent-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .accent-scrollbar::-webkit-scrollbar-track {
            background: var(--scrollbar-track-color);
            border-radius: 10px;
        }
        .accent-scrollbar::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 10px;
        }
        .accent-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--accent-color-hover);
        }


        /* Style for the color input itself */
        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: none;
            width: 40px; /* Same size as other bubbles */
            height: 40px; /* Same size as other bubbles */
            background: none;
            cursor: pointer;
            border-radius: 50%; /* Make it round */
            overflow: hidden; /* Hide default color square */
            padding: 0;
            margin: 0;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 50%; /* Ensure the swatch is round */
        }
        input[type="color"]::-moz-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-moz-color-swatch {
            border: none;
            border-radius: 50%; /* Ensure the swatch is round */
        }
        /* No longer using a static .profile-decoration class in CSS, moved to inline styles for dynamic sizing */
        /* .profile-decoration CSS rules are now applied via React component inline styles */
    </style>
</head>
<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateEmail } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, addDoc, onSnapshot, query, where, serverTimestamp, getDocs, setDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js";
        // Firebase Storage imports are removed as per user request
        // import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-storage.js";


        // define global variables or constants as they would be in the canvas environment
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // START OF REQUIRED FIREBASE CONFIGURATION
        // =================================================================================================
        // IMPORTANT: YOU MUST REPLACE THE ENTIRE 'window.firebaseConfig' OBJECT BELOW
        // WITH YOUR ACTUAL FIREBASE PROJECT CONFIGURATION.
        //
        // HOW TO GET YOUR CONFIG:
        // 1. Go to your Firebase Console: https://console.firebase.google.com/
        // 2. Select your project.
        // 3. Click "Project settings" (gear icon ⚙️) next to "Project overview" in the left navigation.
        // 4. Scroll down to the "Your apps" section.
        // 5. Select your web app (or create one by clicking the `</>` icon).
        // 6. Copy the entire 'firebaseConfig' JavaScript object provided there (including the curly braces).
        // 7. PASTE THAT ENTIRE OBJECT HERE, REPLACING THE CURRENT 'window.firebaseConfig = { ... };'
        // =================================================================================================
        window.firebaseConfig = {
  apiKey: "AIzaSyAlATD81ob8L_3G0dfSiMomhYJCwrMcy7E",
  authDomain: "coffee-shop-chatroom.firebaseapp.com",
  projectId: "coffee-shop-chatroom",
  storageBucket: "coffee-shop-chatroom.firebasestorage.app",
  messagingSenderId: "463370209212",
  appId: "1:463370209212:web:25f17e88f82207d4728db9",
  measurementId: "G-1SLF2KLC4H"
};
        // END OF REQUIRED FIREBASE CONFIGURATION
    
        // If using the default placeholder config, log a warning.
        if (!window.firebaseConfig.apiKey || window.firebaseConfig.projectId === "YOUR_PROJECT_ID") {
            console.error("FIREBASE CONFIGURATION ERROR: You are using placeholder or incomplete Firebase configuration. Please replace 'window.firebaseConfig' with your actual project details from Firebase Console -> Project settings -> Your apps. Ensure 'apiKey' and 'projectId' are correctly filled.");
        }

        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // initialize firebase app globally once and expose instances
        window.app = initializeApp(window.firebaseConfig);
        window.db = getFirestore(window.app);
        window.auth = getAuth(window.app);
        // window.storage = getStorage(window.app); // Storage init removed

        // expose firebase functions globally for the react script
        // by putting them into a single window.firebaseFunctions object
        window.firebaseFunctions = {
            // Functions that are not methods of db or auth directly
            collection: collection,
            doc: doc,
            getDoc: getDoc,
            addDoc: addDoc,
            onSnapshot: onSnapshot,
            query: query,
            where: where,
            serverTimestamp: serverTimestamp,
            getDocs: getDocs,
            setDoc: setDoc,
            deleteDoc: deleteDoc,
            updateDoc: updateDoc,
            // Expose Firebase Auth functions directly
            onAuthStateChanged: onAuthStateChanged,
            signOut: signOut,
            createUserWithEmailAndPassword: createUserWithEmailAndPassword,
            signInWithEmailAndPassword: signInWithEmailAndPassword,
            updateEmail: updateEmail,
        };
    </script>

    <script type="text/babel">
        // access react and reactdom from global scope
        const React = window.React;
        const ReactDOM = window.ReactDOM;

        // access firebase instances from global scope via window
        const appId = window.appId;
        const app = window.app;   // Firebase app instance
        const db = window.db;     // Firestore instance
        const auth = window.auth; // Auth instance

        // Access Firebase functions exposed globally by the module script via window.firebaseFunctions
        const {
            collection,
            doc,
            getDoc,
            addDoc,
            onSnapshot,
            query,
            where,
            serverTimestamp,
            getDocs,
            setDoc,
            deleteDoc,
            updateDoc,
            // Directly access Firebase Auth functions via window.firebaseFunctions
            onAuthStateChanged,
            signOut,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            updateEmail,
         } = window.firebaseFunctions;


        // Utility function to determine contrasting text color (black or white)
        const getContrastingTextColor = (hexColor) => {
            if (!hexColor || !hexColor.startsWith('#')) return '#000000'; // Default to black hex
            const r = parseInt(hexColor.substring(1, 3), 16);
            const g = parseInt(hexColor.substring(3, 5), 16);
            const b = parseInt(hexColor.substring(5, 7), 16);
            // Calculate luminance (perceived brightness)
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.5 ? '#000000' : '#FFFFFF'; // Return black or white hex
        };

        // Helper to generate a consistent DM room ID between two users
        const generateDmRoomCode = (userId1, userId2) => {
            return [userId1, userId2].sort().join('_');
        };

        // New MessageItem component
        const MessageItem = ({ msg, userId, appId, activeRoomCode, db, myMessageBubbleBg, myMessageBubbleText, currentTheme, profilePictureUrl, isAdmin, hoverToDeleteEnabled, onDeleteMessage, onOpenUserProfile, showAdminTag, adminTagColor, adminTagText, showOthersBubbleColors }) => {
            const [isHovered, setIsHovered] = React.useState(false);

            // Effect to mark messages as read
            React.useEffect(() => {
                if (msg.senderId !== userId && (!msg.readBy || !msg.readBy[userId])) {
                    // Check if activeRoomCode corresponds to a DM (simple check for now, can be improved)
                    const isDM = activeRoomCode.includes('_'); 
                    const path = isDM ? `artifacts/${appId}/public/data/dmRooms/${activeRoomCode}/messages` : `artifacts/${appId}/public/data/chatRooms/${activeRoomCode}/messages`;
                    const messageDocRef = doc(db, path, msg.id);

                    updateDoc(messageDocRef, { [`readBy.${userId}`]: true })
                        .catch(error => console.error("Error marking message as read:", error));
                }
            }, [msg.id, msg.senderId, msg.readBy, userId, appId, activeRoomCode, db]);

            // Determine read indicator for current user's messages
            let readIndicator = '';
            if (msg.senderId === userId) {
                const readers = Object.keys(msg.readBy || {}).filter(id => id !== userId);
                if (readers.length > 0) {
                    readIndicator = '✓✓'; // Read by at least one other person
                } else {
                    readIndicator = '✓'; // Sent, but not yet read by others
                }
            }

            // Format time without seconds
            const formattedTime = msg.timestamp?.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            // Apply showOthersBubbleColors logic
            let bubbleBgStyle = {};
            let bubbleBgClass = '';
            let bubbleTextColorClass = '';

            if (msg.senderId === userId) {
                // Always use my own colors for my messages
                bubbleBgStyle = myMessageBubbleBg.startsWith('#') ? { backgroundColor: myMessageBubbleBg } : {};
                bubbleBgClass = myMessageBubbleBg.startsWith('#') ? '' : myMessageBubbleBg;
                bubbleTextColorClass = myMessageBubbleText;
            } else {
                // For others' messages, apply toggle logic
                if (showOthersBubbleColors) {
                    bubbleBgStyle = msg.senderBubbleColor && msg.senderBubbleColor.startsWith('#')
                        ? { backgroundColor: msg.senderBubbleColor }
                        : {};
                    bubbleBgClass = msg.senderBubbleColor && !msg.senderBubbleColor.startsWith('#')
                        ? msg.senderBubbleColor
                        : currentTheme.otherBubbleBg;
                    bubbleTextColorClass = msg.senderBubbleColor && msg.senderBubbleColor.startsWith('#')
                        ? getContrastingTextColor(msg.senderBubbleColor)
                        : currentTheme.otherBubbleText;
                } else {
                    // If toggle is off, force others' bubbles to be my bubble color
                    bubbleBgStyle = myMessageBubbleBg.startsWith('#') ? { backgroundColor: myMessageBubbleBg } : {};
                    bubbleBgClass = myMessageBubbleBg.startsWith('#') ? '' : myMessageBubbleBg;
                    bubbleTextColorClass = myMessageBubbleText; // Use my bubble text color for their bubbles too
                }
            }
            // FIX END

            // Calculate dynamic decoration style
            const decorationSize = msg.senderProfileDecorationSize || 100; // Default to 100%
            const decorationStyle = {
                position: 'absolute',
                width: `${decorationSize}%`,
                height: `${decorationSize}%`,
                top: '50%', // Center vertically
                left: '50%', // Center horizontally
                transform: 'translate(-50%, -50%)', // Adjust for element's own size
                objectFit: 'contain',
                zIndex: 20,
                pointerEvents: 'none',
            };

            return (
                <div
                    key={msg.id}
                    className={`flex mb-4 items-end ${msg.senderId === userId ? 'justify-end' : 'justify-start'}`}
                    onMouseEnter={() => setIsHovered(true)}
                    onMouseLeave={() => setIsHovered(false)}
                >
                    {/* Profile picture for other users (left side) */}
                    {msg.senderId !== userId && msg.senderProfilePictureUrl && (
                        <div className="relative w-8 h-8 flex-shrink-0 mr-2 overflow-visible"> {/* Added overflow-visible */}
                            <img
                                src={msg.senderProfilePictureUrl}
                                alt="PFP"
                                className="w-full h-full rounded-full object-cover cursor-pointer relative z-10"
                                onError={(e) => e.target.src='https://placehold.co/32x32/cccccc/ffffff?text=P'} // Fallback PFP
                                onClick={() => onOpenUserProfile(msg.senderId)}
                            />
                            {msg.senderProfileDecorationUrl && (
                                <img
                                    src={msg.senderProfileDecorationUrl}
                                    alt="Decoration"
                                    style={decorationStyle}
                                    onError={(e) => e.target.style.display='none'} // Hide if error loading decoration
                                />
                            )}
                        </div>
                    )}
                    <div
                        className={`p-3 rounded-xl shadow-sm max-w-[70%] ${bubbleBgClass} ${
                            msg.senderId === userId ? 'rounded-br-none' : 'rounded-bl-none'
                        } relative group overflow-hidden`} // Added overflow-hidden for cleaner overlay
                        style={bubbleBgStyle}
                    >
                        {/* Overlay for dimming effect */}
                        {isAdmin && hoverToDeleteEnabled && (
                            <div className={`absolute inset-0 bg-black/60 transition-opacity duration-300 pointer-events-none ${isHovered ? 'opacity-100' : 'opacity-0'} rounded-xl`}></div>
                        )}

                        <div className={`font-semibold text-sm mb-1 lowercase relative z-10`} style={{color: bubbleTextColorClass}}>
                            {/* Display username/display name for sender */}
                            <span
                                className="cursor-pointer hover:underline"
                                onClick={() => onOpenUserProfile(msg.senderId)}
                            >
                                {msg.senderDisplayName || msg.senderUsername || 'anonymous'}
                            </span>
                            {/* Admin Tag */}
                            {msg.isAdmin && showAdminTag && ( // Only show if isAdmin AND showAdminTag is true
                                <span
                                    className="ml-2 px-2 py-0.5 text-xs rounded-full font-bold uppercase"
                                    style={{ backgroundColor: adminTagColor, color: getContrastingTextColor(adminTagColor) }} // Apply dynamic color
                                >
                                    {adminTagText}
                                </span>
                            )}
                        </div>
                        <p className="text-base break-words relative z-10">{msg.text}</p>
                        <p className={`flex items-center text-xs text-right opacity-80 mt-1 lowercase relative z-10`} style={{color: bubbleTextColorClass}}>
                            {formattedTime} {readIndicator && <span className="ml-1">{readIndicator}</span>}
                        </p>

                        {/* Trash icon for admin to delete messages */}
                        {isAdmin && hoverToDeleteEnabled && (
                            <button
                                onClick={() => onDeleteMessage(msg.id)}
                                className={`absolute inset-0 flex items-center justify-center text-white text-xl transition-opacity duration-300 z-20 ${isHovered ? 'opacity-100' : 'opacity-0'}`}
                                title="Delete Message"
                            >
                                <i className="fas fa-trash-alt"></i>
                            </button>
                        )}
                    </div>
                    {/* Profile picture for current user (right side) */}
                    {msg.senderId === userId && profilePictureUrl && (
                        <div className="relative w-8 h-8 flex-shrink-0 ml-2 overflow-visible"> {/* Added overflow-visible */}
                            <img
                                src={profilePictureUrl}
                                alt="PFP"
                                className="w-full h-full rounded-full object-cover cursor-pointer relative z-10"
                                onError={(e) => e.target.src='https://placehold.co/32x32/cccccc/ffffff?text=P'} // Fallback PFP
                                onClick={() => onOpenUserProfile(msg.senderId)}
                            />
                            {msg.senderProfileDecorationUrl && (
                                <img
                                    src={msg.senderProfileDecorationUrl}
                                    alt="Decoration"
                                    style={decorationStyle}
                                    onError={(e) => e.target.style.display='none'} // Hide if error loading decoration
                                />
                            )}
                        </div>
                    )}
                </div>
            );
        };


        const App = () => {
          const [user, setUser] = React.useState(null); // firebase user object
          const [userId, setUserId] = React.useState(''); // firebase uid or anonymous id
          const [userEmail, setUserEmail] = React.useState(''); // New: User's email from Firebase Auth
          const [displayUsername, setDisplayUsername] = React.useState(''); // The user's public username
          const [displayName, setDisplayName] = React.useState(''); // User's custom display name (can be different from displayUsername)
          const [profilePictureUrl, setProfilePictureUrl] = React.useState(''); // new: profile picture URL
          // Committed states for profile decoration (updated after debounce)
          const [profileDecorationUrl, setProfileDecorationUrl] = React.useState(localStorage.getItem('chat_profile_decoration_url') || ''); // NEW: profile decoration URL
          const [profileDecorationSize, setProfileDecorationSize] = React.useState(parseInt(localStorage.getItem('chat_profile_decoration_size') || '100')); // NEW: profile decoration size
          // Temporary states for live updates in the Admin Panel
          const [tempProfileDecorationUrl, setTempProfileDecorationUrl] = React.useState(''); // For live editing
          const [tempProfileDecorationSize, setTempProfileDecorationSize] = React.useState(100); // For live editing

          const [myBubbleBgColor, setMyBubbleBgColor] = React.useState(''); // new: user's custom bubble background color class or hex
          const [myBubbleTextColor, setMyBubbleTextColor] = React.useState(''); // new: user's custom bubble text color class
          const [isAdmin, setIsAdmin] = React.useState(false); // New: Admin status for current user
          const [isAuthReady, setIsAuthReady] = React.useState(false); // auth initialized
          const [isLoggedIn, setIsLoggedIn] = React.useState(false); // login state based on successful authentication and profile load
          const [bio, setBio] = React.useState(''); // New: User's biography

          // New states for Profile Theme
          const [profileBgFromColor, setProfileBgFromColor] = React.useState(localStorage.getItem('chat_profile_bg_from_color') || '#ffffff'); // Default white
          const [profileBgToColor, setProfileBgToColor] = React.useState(localStorage.getItem('chat_profile_bg_to_color') || '#e0e0e0'); // Default light gray
          const [profileBanner, setProfileBanner] = React.useState(localStorage.getItem('chat_profile_banner') || '');
          const [profileTextColorProfile, setProfileTextColorProfile] = React.useState(localStorage.getItem('chat_profile_text_color') || '');
          const [profileBannerType, setProfileBannerType] = React.useState(localStorage.getItem('chat_profile_banner_type') || 'color'); // 'color' or 'image'
          const [showProfileThemeSettings, setShowProfileThemeSettings] = React.useState(true); // State for Profile Theme dropdown

          const [activeRoomCode, setActiveRoomCode] = React.useState('');
          const [messages, setMessages] = React.useState([]);
          const [newMessageText, setNewMessageText] = React.useState('');

          const [showLoginModal, setShowLoginModal] = React.useState(false);
          const [showRegisterModal, setShowRegisterModal] = React.useState(false);
          const [showProfileModal, setShowProfileModal] = React.useState(false); // New: state for profile modal
          const [showChatSettingsModal, setShowChatSettingsModal] = React.useState(false); // New: state for chat settings modal
          const [showAdminPanelModal, setShowAdminPanelModal] = React.useState(false); // New: state for admin panel modal
          const [hoverToDeleteEnabled, setHoverToDeleteEnabled] = React.useState(false); // New: Admin setting for delete on hover
          const [showConfirmClearModal, setShowConfirmClearModal] = React.useState(false); // New: Confirmation for clear all
          // New state for custom theme accent color
          const [customThemeAccentColor, setCustomThemeAccentColor] = React.useState(localStorage.getItem('chat_custom_theme_accent_color') || '#8b5cf6');
          // NEW: Custom UI background color
          const [customUIBgColor, setCustomUIBgColor] = React.useState(localStorage.getItem('chat_custom_ui_bg_color') || '#ffffff');
          // NEW: Custom UI text color
          const [customUITextColor, setCustomUITextColor] = React.useState(localStorage.getItem('chat_custom_ui_text_color') || '#000000');
          // NEW: Secondary UI text color for less prominent text (like greyed out text)
          const [customUISecondaryTextColor, setCustomUISecondaryTextColor] = React.useState(localStorage.getItem('chat_custom_ui_secondary_text_color') || '#71717a'); // Default to stone-500 equivalent
          // NEW: Secondary UI background color for buttons and other UI elements that previously were light/gray
          const [customUISecondaryBgColor, setCustomUISecondaryBgColor] = React.useState(localStorage.getItem('chat_custom_ui_secondary_bg_color') || '#e7e5e4'); // Default to stone-200 equivalent


          // NEW: Custom Main Background type (color or image)
          const [customMainBgType, setCustomMainBgType] = React.useState(localStorage.getItem('chat_custom_main_bg_type') || 'color'); // 'color' or 'image'
          // NEW: Custom Main Background value (hex or URL)
          const [customMainBgValue, setCustomMainBgValue] = React.useState(localStorage.getItem('chat_custom_main_bg_value') || '#FFFFFF');

          // New states for custom theme presets
          const [customThemePresets, setCustomThemePresets] = React.useState({
              slot1: { name: '', theme: null },
              slot2: { name: '', theme: null },
              slot3: { name: '', theme: null },
          });

          const [showUserProfileModal, setShowUserProfileModal] = React.useState(false);
          const [selectedUserProfileId, setSelectedUserProfileId] = React.useState(null);
          const [friendsList, setFriendsList] = React.useState([]);
          const [currentView, setCurrentView] = React.useState('chatrooms'); // 'chatrooms' or 'dms'
          const [showActiveUsersModal, setShowActiveUsersModal] = React.useState(false); // New state for active users modal

          // New states for kick/ban confirmation modals
          const [showConfirmKickModal, setShowConfirmKickModal] = React.useState(false);
          const [userToKick, setUserToKick] = React.useState(null);
          const [showConfirmBanModal, setShowConfirmBanModal] = React.useState(false);
          const [userToBan, setUserToBan] = React.useState(null);
          const [showConfirmRevertBanModal, setShowConfirmRevertBanModal] = React.useState(false);
          const [userToRevertBan, setUserToRevertBan] = React.useState(null);

          const [showBanMenuModal, setShowBanMenuModal] = React.useState(false); // New state for Ban Menu modal

          // New states for Admin Tag Customization
          const [showAdminTag, setShowAdminTag] = React.useState(true); // Default to true
          const [adminTagColor, setAdminTagColor] = React.useState('#8B5CF6'); // Default to purple-500 hex
          const [adminTagText, setAdminTagText] = React.useState('admin'); // Default text

          // New states for email authentication
          const [loginEmail, setLoginEmail] = React.useState('');
          const [loginPassword, setLoginPassword] = React.useState('');
          const [registerEmail, setRegisterEmail] = React.useState('');
          const [registerPassword, setRegisterPassword] = React.useState('');
          const [registerDisplayName, setRegisterDisplayName] = React.useState(''); // New: For setting display name during registration
          const [joinRoomCode, setJoinRoomCode] = React.useState('');

          const [errorMessage, setErrorMessage] = React.useState('');
          const [successMessage, setSuccessMessage] = React.useState('');
          const [recentRooms, setRecentRooms] = React.useState([]); // New state for recent rooms

          const messagesEndRef = React.useRef(null);
          const messagesContainerRef = React.useRef(null); // Ref for the scrollable messages container
          
          // New state for typing indicator
          const [typingUsers, setTypingUsers] = React.useState([]);
          const typingTimeoutRef = React.useRef(null); // Ref to hold the timeout for typing status
          // New state for showing others' bubble colors
          const [showOthersBubbleColors, setShowOthersBubbleColors] = React.useState(true);

          // NEW: Global Announcement states
          const [globalAnnouncement, setGlobalAnnouncement] = React.useState(null); // { text, senderDisplayName, timestamp }
          const [showGlobalAnnouncement, setShowGlobalAnnouncement] = React.useState(true); // To allow user to dismiss it locally
          const lastDismissedAnnouncementId = React.useRef(localStorage.getItem('chat_last_dismissed_announcement_id') || null);

          // NEW: State for InfoIconModal
          const [showInfoModal, setShowInfoModal] = React.useState(false);
          const [infoModalContent, setInfoModalContent] = React.useState({ title: '', message: '', imageUrl: '' });

          // NEW: State for Changelog Modal
          const [showChangelogModal, setShowChangelogModal] = React.useState(false);


          // Define themes
          const themes = {
            default: {
                name: 'Default',
                mainBgClass: 'bg-gradient-to-br from-stone-50 to-stone-100', // Changed to mainBgClass
                mainBgColorStyle: undefined,
                mainBgImageStyle: {},
                chatBg: 'bg-white',
                messagesBg: 'bg-gray-50',
                myBubbleBg: 'bg-stone-300',
                myBubbleText: 'text-stone-800',
                otherBubbleBg: 'bg-stone-100',
                otherBubbleText: 'text-stone-800',
                textColor: 'text-stone-800', // Primary text
                secondaryText: 'text-stone-500', // Secondary text
                inputBorder: 'border-stone-300',
                inputFocus: 'focus:ring-stone-400',
                inputBg: 'bg-white',
                inputTextColor: 'text-stone-800',
                buttonPrimaryBg: 'bg-stone-700',
                buttonPrimaryHover: 'hover:bg-stone-800',
                buttonSecondaryBg: 'bg-stone-500',
                buttonSecondaryHover: 'hover:bg-stone-600',
                buttonTertiaryBg: 'bg-stone-300', // Secondary UI background for light buttons
                buttonTertiaryText: 'text-stone-800', // Text on secondary UI buttons
                buttonTertiaryHover: 'hover:bg-stone-400',
                scrollbar: 'custom-scrollbar',
                scrollbarVars: {}, // No specific vars for default
            },
            warm: {
                name: 'Warm Coffee',
                mainBgClass: 'bg-gradient-to-br from-amber-50 to-amber-100', // Changed to mainBgClass
                mainBgColorStyle: undefined,
                mainBgImageStyle: {},
                chatBg: 'bg-amber-50',
                messagesBg: 'bg-amber-50',
                myBubbleBg: 'bg-amber-300',
                myBubbleText: 'text-amber-900',
                otherBubbleBg: 'bg-amber-100',
                otherBubbleText: 'text-amber-900',
                textColor: 'text-amber-900',
                secondaryText: 'text-amber-600',
                inputBorder: 'border-amber-300',
                inputFocus: 'focus:ring-amber-400',
                inputBg: 'bg-white',
                inputTextColor: 'text-amber-900',
                buttonPrimaryBg: 'bg-amber-800',
                buttonPrimaryHover: 'hover:bg-amber-900',
                buttonSecondaryBg: 'bg-amber-600',
                buttonSecondaryHover: 'hover:bg-amber-700',
                buttonTertiaryBg: 'bg-amber-300',
                buttonTertiaryText: 'text-amber-900',
                buttonTertiaryHover: 'hover:bg-amber-400',
                scrollbar: 'custom-scrollbar',
                scrollbarVars: {},
            },
            cool: {
                name: 'Cool Breeze',
                mainBgClass: 'bg-gradient-to-br from-blue-50 to-blue-100', // Changed to mainBgClass
                mainBgColorStyle: undefined,
                mainBgImageStyle: {},
                chatBg: 'bg-blue-50',
                messagesBg: 'bg-blue-50',
                myBubbleBg: 'bg-blue-300',
                myBubbleText: 'text-blue-800',
                otherBubbleBg: 'bg-blue-100',
                otherBubbleText: 'text-blue-800',
                textColor: 'text-blue-800',
                secondaryText: 'text-blue-500',
                inputBorder: 'border-blue-300',
                inputFocus: 'focus:ring-blue-400',
                inputBg: 'bg-white',
                inputTextColor: 'text-blue-800',
                buttonPrimaryBg: 'bg-blue-700',
                buttonPrimaryHover: 'hover:bg-blue-800',
                buttonSecondaryBg: 'bg-blue-500',
                buttonSecondaryHover: 'hover:bg-blue-600',
                buttonTertiaryBg: 'bg-blue-300',
                buttonTertiaryText: 'text-blue-800',
                buttonTertiaryHover: 'hover:bg-blue-400',
                scrollbar: 'custom-scrollbar',
                scrollbarVars: {},
            },
          };

          const [currentThemeName, setCurrentThemeName] = React.useState(localStorage.getItem('chat_theme') || 'default');
          // Dynamic currentTheme calculation
          const currentTheme = React.useMemo(() => {
              if (currentThemeName === 'custom') {
                  // Primary text color is customUITextColor
                  // Secondary text color is customUISecondaryTextColor
                  // UI Background is customUIBgColor
                  // Secondary UI background (buttons, etc.) is customUISecondaryBgColor

                  const primaryButtonColor = customThemeAccentColor;
                  const primaryButtonTextColor = getContrastingTextColor(primaryButtonColor);
                  
                  const secondaryButtonColor = customUISecondaryBgColor;
                  const secondaryButtonTextColor = getContrastingTextColor(secondaryButtonColor);

                  const otherBubbleBgColor = getContrastingTextColor(customUIBgColor) === '#000000' ? '#e0e0e0' : '#333333'; // Default other bubble if not set by user
                  const otherBubbleTextColor = getContrastingTextColor(otherBubbleBgColor);

                  // Calculate hover color for accent scrollbar thumb
                  const r = parseInt(customThemeAccentColor.substring(1, 3), 16);
                  const g = parseInt(customThemeAccentColor.substring(3, 5), 16);
                  const b = parseInt(customThemeAccentColor.substring(5, 7), 16);
                  const accentColorHover = `rgb(${Math.min(255, r + 30)}, ${Math.min(255, g + 30)}, ${Math.min(255, b + 30)})`; // Slightly lighter for hover

                  const scrollbarTrackColor = getContrastingTextColor(customUIBgColor) === '#000000' ? '#e7e5e4' : '#3f3f46'; // stone-200 or stone-700


                  return {
                      name: 'Custom',
                      mainBgClass: '', // Will be handled by inline style
                      mainBgColorStyle: customMainBgType === 'color' ? customMainBgValue : undefined,
                      mainBgImageStyle: customMainBgType === 'image' ? { backgroundImage: `url(${customMainBgValue})`, backgroundSize: 'cover', backgroundPosition: 'center', backgroundRepeat: 'no-repeat' } : {},
                      
                      chatBg: `bg-[${customUIBgColor}]`,
                      messagesBg: `bg-[${customUIBgColor}]`, // Messages background typically same as chat background
                      
                      myBubbleBg: `bg-[${customThemeAccentColor}]`, // My bubble color is always accent
                      myBubbleText: getContrastingTextColor(customThemeAccentColor),
                      
                      otherBubbleBg: `bg-[${otherBubbleBgColor}]`,
                      otherBubbleText: `text-[${otherBubbleTextColor}]`,
                      
                      textColor: `text-[${customUITextColor}]`, // Primary UI text color
                      secondaryText: `text-[${customUISecondaryTextColor}]`, // Secondary UI text color

                      inputBorder: `border-[${getContrastingTextColor(customUIBgColor) === '#000000' ? '#d6d3d1' : '#52525b'}]`, // Contrast with UI bg for input borders
                      inputFocus: 'focus:ring-blue-500', // Standard focus ring
                      inputBg: `bg-[${customUIBgColor}]`,
                      inputTextColor: `text-[${customUITextColor}]`,
                      
                      buttonPrimaryBg: `bg-[${primaryButtonColor}]`,
                      buttonPrimaryHover: 'hover:brightness-125',
                      buttonPrimaryText: `text-[${primaryButtonTextColor}]`, // Explicit primary button text color
                      
                      buttonSecondaryBg: `bg-[${customUISecondaryBgColor}]`, // Secondary action buttons (e.g., leave room)
                      buttonSecondaryHover: 'hover:brightness-125',
                      buttonSecondaryText: `text-[${secondaryButtonTextColor}]`,
                      
                      buttonTertiaryBg: `bg-[${customUISecondaryBgColor}]`, // Tertiary buttons (e.g., room selection, preset save/load)
                      buttonTertiaryText: `text-[${secondaryButtonTextColor}]`,
                      buttonTertiaryHover: 'hover:brightness-110',
                      
                      scrollbar: 'accent-scrollbar', // Use the new accent-controlled scrollbar
                      scrollbarVars: { // Define CSS variables for the accent-scrollbar
                          '--accent-color': customThemeAccentColor,
                          '--accent-color-hover': accentColorHover,
                          '--scrollbar-track-color': scrollbarTrackColor,
                      },
                  };
              }
              // For default, warm, cool themes, ensure they also use the new properties for consistency
              const selectedTheme = themes[currentThemeName];
              return {
                ...selectedTheme,
                mainBgClass: selectedTheme.mainBgClass,
                mainBgColorStyle: undefined,
                mainBgImageStyle: {},
                messagesBg: selectedTheme.messagesBg || selectedTheme.chatBg, // Default to chatBg if not explicitly set
                inputBg: selectedTheme.inputBg || 'bg-white',
                inputTextColor: selectedTheme.inputTextColor || selectedTheme.textColor,
                scrollbar: selectedTheme.scrollbar || 'custom-scrollbar',
                // Ensure text colors are explicitly passed for non-custom themes too
                textColor: selectedTheme.textColor,
                secondaryText: selectedTheme.secondaryText,
                // Ensure secondary button colors are consistent with tertiary for simplicity in themes
                buttonSecondaryBg: selectedTheme.buttonSecondaryBg,
                buttonSecondaryHover: selectedTheme.buttonSecondaryHover,
                buttonSecondaryText: 'text-white', // Assume white for default secondary buttons
                buttonPrimaryText: 'text-white', // Assume white for default primary buttons
                scrollbarVars: {}, // No special vars for built-in themes
              };
          }, [currentThemeName, customThemeAccentColor, customUIBgColor, customUITextColor, customUISecondaryTextColor, customUISecondaryBgColor, customMainBgType, customMainBgValue, themes]);

          // Define bubble color options for profile settings
          const bubbleColorOptions = [
            { id: 'stone', bgClass: 'bg-stone-300', textClass: 'text-black', label: 'Default' }, // Muted
            { id: 'blue', bgClass: 'bg-blue-300', textClass: 'text-blue-800', label: 'Blue' }, // Muted
            { id: 'green', bgClass: 'bg-green-300', textClass: 'text-green-800', label: 'Green' }, // Muted
            { id: 'red', bgClass: 'bg-red-300', textClass: 'text-red-800', label: 'Red' }, // Muted
            { id: 'yellow', bgClass: 'bg-yellow-200', textClass: 'text-black', label: 'Yellow' }, // Muted
            { id: 'purple', bgClass: 'bg-purple-300', textClass: 'text-purple-800', label: 'Purple' }, // Muted
            { id: 'gray', bgClass: 'bg-gray-300', textClass: 'text-gray-800', label: 'Dark Gray' }, // Muted
            { id: 'fuchsia', bgClass: 'bg-fuchsia-300', textClass: 'text-fuchsia-800', label: 'Fuchsia' }, // Muted
          ];


          // predefined chatrooms for the left panel
          const predefinedChatrooms = [
            { name: 'cafe-chat', label: 'cafe chat' },
            { name: 'study-nook', label: 'study nook' },
            { name: 'book-club', label: 'book club' },
            { name: 'games-room', label: 'games room' },
            { name: 'general-discussions', label: 'general discussions' },
            { name: 'tech-talk', label: 'tech talk' },
            { name: 'art-zone', label: 'art zone' },
          ];

          // scroll to the bottom of the messages div
          const scrollToBottom = (force = false) => {
            if (messagesEndRef.current && messagesContainerRef.current) {
                const container = messagesContainerRef.current;
                const isAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 50; // 50px tolerance
                if (force || isAtBottom) {
                    messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
                }
            }
          };

          // Function to update user activity timestamp
          const updateUserActivity = React.useCallback(async (roomCode, currentUserId) => {
              if (!currentUserId || !roomCode) return;
              const activityRef = doc(db, `artifacts/${appId}/public/data/chatroomActivity/${roomCode}/users`, currentUserId);
              try {
                  await setDoc(activityRef, { lastActivity: serverTimestamp() }, { merge: true });
              } catch (error) {
                  console.error("Error updating user activity:", error);
              }
          }, [db, appId]);

          // Function to update typing status in Firestore
          const updateTypingStatus = React.useCallback(async (isTyping) => {
              if (!userId || !activeRoomCode || !isLoggedIn) return;

              const isDM = activeRoomCode.includes('_');
              const typingStatusPath = isDM
                  ? `artifacts/${appId}/public/data/dmRooms/${activeRoomCode}/typingStatus`
                  : `artifacts/${appId}/public/data/chatRooms/${activeRoomCode}/typingStatus`;

              try {
                  const userTypingRef = doc(db, typingStatusPath, userId);
                  await setDoc(userTypingRef, {
                      isTyping: isTyping,
                      timestamp: serverTimestamp(),
                      displayName: displayName || displayUsername, // Include display name for easy retrieval
                      profilePictureUrl: profilePictureUrl // Include profile picture for typing indicator
                  }, { merge: true });
                  console.log(`Typing status for ${userId} set to: ${isTyping}`);
              } catch (error) {
                  console.error("Error updating typing status:", error);
              }
          }, [userId, activeRoomCode, isLoggedIn, db, appId, displayName, displayUsername, profilePictureUrl]);

          // Modified initial data loading and Firestore saving
          const saveUserSettingsToFirestore = React.useCallback(async () => {
            if (!userId) return;

            const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/userProfiles`, userId);
            try {
                await setDoc(userProfileRef, {
                    // Profile details
                    email: userEmail,
                    displayUsername: displayUsername,
                    displayName: displayName,
                    profilePictureUrl: profilePictureUrl,
                    profileDecorationUrl: profileDecorationUrl,
                    profileDecorationSize: profileDecorationSize,
                    myBubbleBgColor: myBubbleBgColor,
                    myBubbleTextColor: myBubbleTextColor,
                    bio: bio,
                    profileBgFromColor: profileBgFromColor,
                    profileBgToColor: profileBgToColor,
                    profileBanner: profileBanner,
                    profileTextColorProfile: profileTextColorProfile,
                    profileBannerType: profileBannerType,
                    
                    // Chat Settings
                    currentThemeName: currentThemeName, // Save selected theme name
                    customThemeAccentColor: customThemeAccentColor,
                    customUIBgColor: customUIBgColor,
                    customUITextColor: customUITextColor,
                    customUISecondaryTextColor: customUISecondaryTextColor, // NEW: Secondary text color
                    customUISecondaryBgColor: customUISecondaryBgColor, // NEW: Secondary UI background color
                    customMainBgType: customMainBgType,
                    customMainBgValue: customMainBgValue,
                    customThemePresets: customThemePresets, // Save presets
                    showOthersBubbleColors: showOthersBubbleColors, // Save toggle state

                    // Recent Rooms moved to Firestore
                    recentRooms: recentRooms, // Save recent rooms

                }, { merge: true }); // Merge ensures other fields aren't overwritten
                console.log("User settings saved to Firestore.");
            } catch (error) {
                console.error("Error saving user settings to Firestore:", error);
                setErrorMessage("Failed to save settings.");
            }
          }, [
              userId, db, appId, userEmail, displayUsername, displayName, profilePictureUrl,
              profileDecorationUrl, profileDecorationSize, myBubbleBgColor, myBubbleTextColor, bio,
              profileBgFromColor, profileBgToColor, profileBanner, profileTextColorProfile, profileBannerType,
              currentThemeName, customThemeAccentColor, customUIBgColor, customUITextColor,
              customUISecondaryTextColor, customUISecondaryBgColor, // NEW dependencies
              customMainBgType, customMainBgValue, customThemePresets, recentRooms, showOthersBubbleColors
          ]);

          React.useEffect(() => {
            const authenticateFirebase = async () => {
              try {
                setIsAuthReady(true);
              } catch (error) {
                console.error("Firebase initialization error:", error);
                setErrorMessage(`Initialization failed: ${error.message}`);
              }
            };

            authenticateFirebase();

            const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
              setUser(currentUser);
              console.log("onAuthStateChanged: Current user:", currentUser ? currentUser.uid : "null");
              if (currentUser) {
                setUserId(currentUser.uid);
                setUserEmail(currentUser.email || '');
                
                const userProfileRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/userProfiles`, currentUser.uid);
                try {
                  const userProfileSnap = await getDoc(userProfileRef);
                  if (userProfileSnap.exists()) {
                    const profileData = userProfileSnap.data();
                    // Load Profile details
                    setDisplayUsername(profileData.displayUsername || '');
                    setDisplayName(profileData.displayName || profileData.displayUsername || 'anonymous');
                    setProfilePictureUrl(profileData.profilePictureUrl || '');
                    setProfileDecorationUrl(profileData.profileDecorationUrl || '');
                    setTempProfileDecorationUrl(profileData.profileDecorationUrl || '');
                    setProfileDecorationSize(parseInt(profileData.profileDecorationSize || '100'));
                    setTempProfileDecorationSize(parseInt(profileData.profileDecorationSize || '100'));
                    setMyBubbleBgColor(profileData.myBubbleBgColor || '');
                    setMyBubbleTextColor(profileData.myBubbleTextColor || '');
                    setBio(profileData.bio || '');
                    setIsAdmin(profileData.isAdmin || false);
                    setProfileBgFromColor(profileData.profileBgFromColor || '#ffffff');
                    setProfileBgToColor(profileData.profileBgToColor || '#e0e0e0');
                    setProfileBanner(profileData.profileBanner || '');
                    setProfileTextColorProfile(profileData.profileTextColorProfile || '');
                    setProfileBannerType(profileData.profileBannerType || 'color');

                    // Load Chat Settings
                    setCurrentThemeName(profileData.currentThemeName || 'default');
                    setCustomThemeAccentColor(profileData.customThemeAccentColor || '#8b5cf6');
                    setCustomUIBgColor(profileData.customUIBgColor || '#ffffff');
                    setCustomUITextColor(profileData.customUITextColor || '#000000');
                    setCustomUISecondaryTextColor(profileData.customUISecondaryTextColor || '#71717a'); // NEW
                    setCustomUISecondaryBgColor(profileData.customUISecondaryBgColor || '#e7e5e4'); // NEW
                    customMainBgType(profileData.customMainBgType || 'color');
                    setCustomMainBgValue(profileData.customMainBgValue || '#FFFFFF');
                    setCustomThemePresets(profileData.customThemePresets || { slot1: { name: '', theme: null }, slot2: { name: '', theme: null }, slot3: { name: '', theme: null } });
                    setShowOthersBubbleColors(profileData.showOthersBubbleColors !== undefined ? profileData.showOthersBubbleColors : true); // Default to true

                    // Load Recent Rooms from Firestore
                    setRecentRooms(profileData.recentRooms || []);

                    setIsLoggedIn(true);
                    console.log("onAuthStateChanged: User profile and settings fetched from Firestore:", profileData);
                  } else {
                    console.log("onAuthStateChanged: User authenticated via Firebase, but no profile in Firestore. Showing login modal.");
                    setIsLoggedIn(false);
                    setShowLoginModal(true);
                    // Clear local storage for old/missing profiles
                    localStorage.removeItem('chat_display_username');
                    localStorage.removeItem('chat_display_name');
                    // ... (clear other local storage items that are now in Firestore profile)
                  }
                } catch (error) {
                  console.error("Error fetching user profile:", error);
                  setErrorMessage("Failed to load user profile.");
                  setIsLoggedIn(false);
                  setShowLoginModal(true);
                }
              } else {
                console.log("onAuthStateChanged: No current user, resetting states.");
                setUserId('');
                setUserEmail('');
                setDisplayUsername('');
                setDisplayName('');
                setProfilePictureUrl('');
                setProfileDecorationUrl('');
                setTempProfileDecorationUrl('');
                setProfileDecorationSize(100);
                setTempProfileDecorationSize(100);
                setMyBubbleBgColor('');
                setMyBubbleTextColor('');
                setBio('');
                setIsAdmin(false);
                setIsLoggedIn(false);
                setShowLoginModal(true);
                setActiveRoomCode('');
                setMessages([]);
                setRecentRooms([]); // Reset recent rooms
                // Reset custom theme settings to defaults
                setCurrentThemeName('default');
                setCustomThemeAccentColor('#8b5cf6');
                setCustomUIBgColor('#ffffff');
                setCustomUITextColor('#000000');
                setCustomUISecondaryTextColor('#71717a'); // NEW
                setCustomUISecondaryBgColor('#e7e5e4'); // NEW
                setCustomMainBgType('color');
                setCustomMainBgValue('#FFFFFF');
                setCustomThemePresets({ slot1: { name: '', theme: null }, slot2: { name: '', theme: null }, slot3: { name: '', theme: null } });
                setShowOthersBubbleColors(true);
                // Clear all relevant local storage items
                // ... (ensure all relevant keys are cleared)
              }
            });

            return () => unsubscribe();
          }, [auth, db, appId]); // Added auth, db, and appId to the dependency array
          
          // Use another useEffect to save settings whenever a relevant state changes
          React.useEffect(() => {
            if (isLoggedIn && userId) { // Only save if logged in and userId is set
                const handler = setTimeout(() => {
                    saveUserSettingsToFirestore();
                }, 1000); // Debounce saves by 1 second

                return () => clearTimeout(handler);
            }
          }, [
              isLoggedIn, userId, userEmail, displayUsername, displayName, profilePictureUrl,
              profileDecorationUrl, profileDecorationSize, myBubbleBgColor, myBubbleTextColor, bio,
              profileBgFromColor, profileBgToColor, profileBanner, profileTextColorProfile, profileBannerType,
              currentThemeName, customThemeAccentColor, customUIBgColor, customUITextColor,
              customUISecondaryTextColor, customUISecondaryBgColor, // NEW dependencies
              customMainBgType, customMainBgValue, customThemePresets, recentRooms, showOthersBubbleColors,
              saveUserSettingsToFirestore // Include the memoized save function
          ]);

          // Debounce effect for profile decoration URL and size
          React.useEffect(() => {
              if (!userId) return; // Do not debounce if user is not authenticated

              const handler = setTimeout(async () => {
                  // Only save if the temporary values are different from the committed ones
                  // This prevents unnecessary writes if user just opened modal and closed.
                  if (tempProfileDecorationUrl !== profileDecorationUrl || tempProfileDecorationSize !== profileDecorationSize) {
                      console.log("Debounced saving decoration changes to Firestore...");
                      try {
                          const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/userProfiles`, userId);
                          await setDoc(userProfileRef, {
                              profileDecorationUrl: tempProfileDecorationUrl,
                              profileDecorationSize: tempProfileDecorationSize,
                          }, { merge: true });

                          // Update the committed states after successful Firestore write
                          setProfileDecorationUrl(tempProfileDecorationUrl);
                          setProfileDecorationSize(tempProfileDecorationSize);
                          // Update local storage too (for redundancy/initial load before Firestore kicks in)
                          localStorage.setItem('chat_profile_decoration_url', tempProfileDecorationUrl);
                          localStorage.setItem('chat_profile_decoration_size', tempProfileDecorationSize.toString());
                          setSuccessMessage('decoration changes saved!');
                      } catch (error) {
                          setErrorMessage('failed to save decoration changes.');
                          console.error('Error saving decoration changes:', error);
                      }
                  }
              }, 500); // 500ms debounce time

              // Cleanup: clear the timer if the inputs change again before the timeout fires
              return () => {
                  clearTimeout(handler);
              };
          }, [tempProfileDecorationUrl, tempProfileDecorationSize, profileDecorationUrl, profileDecorationSize, db, appId, userId, setSuccessMessage, setErrorMessage]);


          // New useEffect for admin settings (e.g., hoverToDeleteEnabled) and new admin tag settings
          React.useEffect(() => {
            if (!isAuthReady) return;

            const adminSettingsRef = doc(db, `artifacts/${appId}/public/data/adminSettings`, 'general');

            const unsubscribe = onSnapshot(adminSettingsRef, (docSnap) => {
                if (docSnap.exists()) {
                    const settings = docSnap.data();
                    setHoverToDeleteEnabled(settings.hoverToDeleteEnabled || false);
                    setShowAdminTag(settings.showAdminTag !== undefined ? settings.showAdminTag : true); // Default to true
                    setAdminTagColor(settings.adminTagColor || '#8B5CF6'); // Default to purple-500 hex
                    setAdminTagText(settings.adminTagText || 'admin'); // Default to 'admin'
                    console.log("Admin settings fetched:", settings);
                } else {
                    // If settings document doesn't exist, create it with default values
                    console.log("Admin settings document not found, creating with default.");
                    setDoc(adminSettingsRef, { 
                        hoverToDeleteEnabled: false,
                        showAdminTag: true,
                        adminTagColor: '#8B5CF6',
                        adminTagText: 'admin',
                    }, { merge: true })
                        .catch(error => console.error("Error creating default admin settings:", error));
                }
            }, (error) => {
                console.error("Error fetching admin settings:", error);
            });

            return () => unsubscribe();
          }, [isAuthReady, db, appId]);

          // Effect to listen for friends list changes
          React.useEffect(() => {
            if (!isAuthReady || !userId || !isLoggedIn) return;

            const friendsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/friends`);
            const unsubscribe = onSnapshot(friendsCollectionRef, async (snapshot) => {
                const fetchedFriends = [];
                for (const docSnap of snapshot.docs) {
                    const friendId = docSnap.id;
                    const friendDataFromFriendsCollection = docSnap.data(); // Get data from the friend's document
                    const dmRoomCode = friendDataFromFriendsCollection.dmRoomCode; // Extract dmRoomCode

                    const friendProfileRef = doc(db, `artifacts/${appId}/users/${friendId}/userProfiles`, friendId);
                    try {
                        const friendProfileSnap = await getDoc(friendProfileRef);
                        if (friendProfileSnap.exists()) {
                            fetchedFriends.push({
                                id: friendId,
                                ...friendProfileSnap.data(), // Spread profile data
                                dmRoomCode: dmRoomCode
                            });
                        } else {
                            // Fallback if profile not found (e.g., deleted user)
                            console.warn(`Profile for friend ${friendId} not found, using basic info.`);
                            fetchedFriends.push({
                                id: friendId,
                                displayUsername: friendId,
                                displayName: friendDataFromFriendsCollection.displayName || friendId, // Use stored displayName or ID
                                profilePictureUrl: '',
                                profileDecorationUrl: '', // Default empty decoration
                                profileDecorationSize: 100, // Default size
                                dmRoomCode: dmRoomCode
                            });
                        }
                    } catch (error) {
                        console.error(`Error fetching profile for friend ${friendId}:`, error);
                    }
                }
                setFriendsList(fetchedFriends);
                console.log("Friends list updated:", fetchedFriends);
            }, (error) => {
                console.error("Error fetching friends list:", error);
            });

            return () => unsubscribe();
          }, [isAuthReady, userId, isLoggedIn, db, appId]); // Added db, appId to dependencies

          React.useEffect(() => {
            console.log("Messages useEffect triggered. activeRoomCode:", activeRoomCode, "isLoggedIn:", isLoggedIn, "userId:", userId);
            if (!isAuthReady || !activeRoomCode || !isLoggedIn || !userId) {
              console.log("Messages useEffect skipped due to missing dependencies (AuthReady:", isAuthReady, "RoomCode:", activeRoomCode, "LoggedIn:", isLoggedIn, "UserId:", userId, ")");
              setMessages([]); // Clear messages if conditions are not met
              return;
            }

            // Determine if it's a DM room or a public chat room
            const isDM = activeRoomCode.includes('_');
            const messagesPath = isDM
                ? `artifacts/${appId}/public/data/dmRooms/${activeRoomCode}/messages`
                : `artifacts/${appId}/public/data/chatRooms/${activeRoomCode}/messages`;

            console.log("Messages useEffect: Attempting to listen to messages from path:", messagesPath);

            const messagesCollectionRef = collection(db, messagesPath);
            const q = query(messagesCollectionRef);

            const unsubscribe = onSnapshot(q, (snapshot) => {
              const newFetchedMessages = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              newFetchedMessages.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));
              
              setMessages(newFetchedMessages); 
              scrollToBottom(); 
              console.log(`Messages useEffect: Fetched ${newFetchedMessages.length} messages for room ${activeRoomCode}`);
            }, (error) => {
              console.error(`Messages useEffect: ERROR fetching messages for room ${activeRoomCode} from path ${messagesPath}:`, error); // Added detailed error log
              setErrorMessage("failed to load messages.");
            });

            return () => unsubscribe();
          }, [activeRoomCode, isAuthReady, isLoggedIn, userId, db, appId]); // Removed messages.length from dependencies

          // Effect to periodically update user activity for the active room
          React.useEffect(() => {
              let intervalId;
              if (isLoggedIn && userId && activeRoomCode) {
                  // Update activity immediately upon joining/component mount
                  updateUserActivity(activeRoomCode, userId);
                  // Then, update every 60 seconds
                  intervalId = setInterval(() => {
                      updateUserActivity(activeRoomCode, userId);
                  }, 60000); // Update every 60 seconds
              }

              return () => {
                  if (intervalId) {
                      clearInterval(intervalId);
                  }
              };
          }, [isLoggedIn, userId, activeRoomCode, updateUserActivity]);

          // Effect to listen for typing status
          React.useEffect(() => {
            if (!isAuthReady || !activeRoomCode || !isLoggedIn) {
                setTypingUsers([]); // Clear typing users when not in a room or not logged in
                return;
            }

            const isDM = activeRoomCode.includes('_');
            const typingStatusPath = isDM
                ? `artifacts/${appId}/public/data/dmRooms/${activeRoomCode}/typingStatus`
                : `artifacts/${appId}/public/data/chatRooms/${activeRoomCode}/typingStatus`;

            const typingCollectionRef = collection(db, typingStatusPath);

            const unsubscribe = onSnapshot(typingCollectionRef, (snapshot) => {
                const now = Date.now();
                const freshTypingUsers = [];
                snapshot.docs.forEach(docSnap => {
                    const typingData = docSnap.data();
                    const typerId = docSnap.id;

                    // Exclude self and check for recent activity (within last 8 seconds)
                    if (typerId !== userId && typingData.isTyping && (now - (typingData.timestamp?.toMillis() || 0) < 8000)) {
                        freshTypingUsers.push({
                            id: typerId,
                            displayName: typingData.displayName || typingData.displayUsername || 'anonymous',
                            profilePictureUrl: typingData.profilePictureUrl || ''
                        });
                    }
                });
                setTypingUsers(freshTypingUsers);
            }, (error) => {
                console.error("Error fetching typing status:", error);
            });

            return () => {
                // On unmount or room change, clear local user's typing status
                if (userId && activeRoomCode && isLoggedIn) {
                    updateTypingStatus(false);
                }
                unsubscribe();
            };
          }, [activeRoomCode, isAuthReady, isLoggedIn, userId, db, appId, updateTypingStatus]);

          // NEW: Effect to listen for global announcements
          React.useEffect(() => {
            if (!isAuthReady) return;

            const announcementDocRef = doc(db, `artifacts/${appId}/public/data/globalAnnouncements`, 'latestAnnouncement');

            const unsubscribe = onSnapshot(announcementDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Only show if it's a new announcement or if it's not the one we last dismissed
                    if (data.id && data.id !== lastDismissedAnnouncementId.current) {
                        setGlobalAnnouncement(data);
                        setShowGlobalAnnouncement(true); // Always show new announcements
                    } else if (data.id && data.id === lastDismissedAnnouncementId.current) {
                        // If it's the same announcement we dismissed, don't show it
                        setShowGlobalAnnouncement(false);
                    } else {
                        // Handle cases where ID might be missing or it's an initial load of a previously dismissed announcement
                        setGlobalAnnouncement(null);
                        setShowGlobalAnnouncement(false);
                    }
                } else {
                    setGlobalAnnouncement(null);
                    setShowGlobalAnnouncement(false);
                }
            }, (error) => {
                console.error("Error fetching global announcement:", error);
            });

            return () => unsubscribe();
          }, [isAuthReady, db, appId]);


          const handleRegister = async (e) => {
            e.preventDefault();
            setErrorMessage('');
            setSuccessMessage('');

            if (!registerEmail || !registerPassword || !registerDisplayName) {
              setErrorMessage('email, password, and display name are required.');
              return;
            }

            try {
              // 1. Create user with email and password using Firebase Auth
              const userCredential = await createUserWithEmailAndPassword(auth, registerEmail, registerPassword);
              const registeredUser = userCredential.user;

              // 2. Store user profile details in the user's private collection
              const newUserProfileData = {
                email: registerEmail, // Store email in profile for easy access
                displayUsername: registerDisplayName.toLowerCase(), // Save display name as public username
                displayName: registerDisplayName, // Save display name
                profilePictureUrl: '', // Default empty profile picture
                profileDecorationUrl: '', // NEW: Default empty decoration
                profileDecorationSize: 100, // NEW: Default decoration size
                myBubbleBgColor: '', // Default empty bubble background color
                myBubbleTextColor: '', // Default empty bubble text color
                bio: '', // Initialize bio as empty
                // Initialize profile theme settings
                profileBgFromColor: '#ffffff',
                profileBgToColor: '#e0e0e0',
                profileBanner: '',
                profileTextColorProfile: '',
                profileBannerType: 'color',
                isAdmin: false, // Default to not an admin
                createdAt: serverTimestamp(),
                // NEW: Initialize custom UI theme settings
                customUIBgColor: '#ffffff',
                customUITextColor: '#000000',
                customUISecondaryTextColor: '#71717a', // NEW
                customUISecondaryBgColor: '#e7e5e4', // NEW
                customMainBgType: 'color',
                customMainBgValue: '#FFFFFF',
                // Initialize new settings
                currentThemeName: 'default',
                customThemePresets: { slot1: { name: '', theme: null }, slot2: { name: '', theme: null }, slot3: { name: '', theme: null } },
                showOthersBubbleColors: true,
                recentRooms: [],
              };

              await setDoc(doc(db, `artifacts/${appId}/users/${registeredUser.uid}/userProfiles`, registeredUser.uid), newUserProfileData);

              // Update local state and local storage
              setUserId(registeredUser.uid);
              setUserEmail(registeredUser.email);
              setDisplayUsername(registerDisplayName.toLowerCase());
              setDisplayName(registerDisplayName);
              setProfilePictureUrl('');
              setProfileDecorationUrl('');
              setTempProfileDecorationUrl('');
              setProfileDecorationSize(100);
              setTempProfileDecorationSize(100);
              setMyBubbleBgColor('');
              setMyBubbleTextColor('');
              setBio('');
              setProfileBgFromColor('#ffffff');
              setProfileBgToColor('#e0e0e0');
              setProfileBanner('');
              setProfileTextColorProfile('');
              setProfileBannerType('color');
              setIsAdmin(false);
              setIsLoggedIn(true);
              setShowRegisterModal(false);
              setSuccessMessage('registration successful! you are now logged in.');

              // Update local storage for redundancy, but Firestore is source of truth now
              localStorage.setItem('chat_display_username', registerDisplayName.toLowerCase());
              localStorage.setItem('chat_display_name', registerDisplayName);
              localStorage.setItem('chat_profile_picture_url', '');
              localStorage.setItem('chat_profile_decoration_url', '');
              localStorage.setItem('chat_profile_decoration_size', '100');
              localStorage.setItem('chat_bubble_bg_color', '');
              localStorage.setItem('chat_bubble_text_color', '');
              localStorage.setItem('chat_bio', '');
              localStorage.setItem('chat_profile_bg_from_color', '#ffffff');
              localStorage.setItem('chat_profile_bg_to_color', '#e0e0e0');
              localStorage.setItem('chat_profile_banner', '');
              localStorage.setItem('chat_profile_text_color', '');
              localStorage.setItem('chat_profile_banner_type', 'color');
              localStorage.setItem('chat_custom_ui_bg_color', '#ffffff');
              localStorage.setItem('chat_custom_ui_text_color', '#000000');
              localStorage.setItem('chat_custom_ui_secondary_text_color', '#71717a'); // NEW
              localStorage.setItem('chat_custom_ui_secondary_bg_color', '#e7e5e4'); // NEW
              localStorage.setItem('chat_custom_main_bg_type', 'color');
              localStorage.setItem('chat_custom_main_bg_value', '#FFFFFF');
              localStorage.setItem('chat_theme', 'default');
              localStorage.setItem('chat_custom_theme_accent_color', '#8b5cf6');
              // No need to save presets/recentRooms/showOthersBubbleColors to localStorage directly as they are now in Firestore.
              console.log("Registered and logged in user:", registeredUser.email);

            } catch (error) {
              console.error('error during registration:', error);
              setErrorMessage(`registration failed: ${error.message}`);
            }
          };

          const handleLogin = async (e) => {
            e.preventDefault();
            setErrorMessage('');
            setSuccessMessage('');

            if (!loginEmail || !loginPassword) {
              setErrorMessage('email and password are required.');
              return;
            }

            try {
                // Check for global ban first (using the email's UID if available, or a fallback)
                const potentialUid = auth.currentUser ? auth.currentUser.uid : null;
                if (potentialUid) {
                    const banDocRef = doc(db, `artifacts/${appId}/public/data/bannedUsers`, potentialUid);
                    const banSnap = await getDoc(banDocRef);
                    if (banSnap.exists()) {
                        const banData = banSnap.data();
                        const banUntilTime = banData.banUntil?.toDate().getTime();
                        if (banUntilTime && Date.now() < banUntilTime) {
                            setErrorMessage(`you are temporarily banned until ${new Date(banUntilTime).toLocaleTimeString()}.`);
                            return;
                        } else {
                            // Ban expired, clean up
                            await deleteDoc(banDocRef).catch(console.error);
                        }
                    }
                }

                const userCredential = await signInWithEmailAndPassword(auth, loginEmail, loginPassword);
                const loggedInUser = userCredential.user;

                setUserId(loggedInUser.uid);
                setUserEmail(loggedInUser.email);

                const userProfileRef = doc(db, `artifacts/${appId}/users/${loggedInUser.uid}/userProfiles`, loggedInUser.uid);
                let profileData = {};
                try {
                    const userProfileSnap = await getDoc(userProfileRef);
                    if (userProfileSnap.exists()) {
                        profileData = userProfileSnap.data();
                    } else {
                        console.warn("User profile not found in Firestore, creating a new one.");
                        profileData = {
                            email: loggedInUser.email,
                            displayUsername: loggedInUser.email.split('@')[0],
                            displayName: loggedInUser.email.split('@')[0],
                            profilePictureUrl: '',
                            profileDecorationUrl: '',
                            profileDecorationSize: 100,
                            myBubbleBgColor: '',
                            myBubbleTextColor: '',
                            bio: '',
                            profileBgFromColor: '#ffffff',
                            profileBgToColor: '#e0e0e0',
                            profileBanner: '',
                            profileTextColorProfile: '',
                            profileBannerType: 'color',
                            isAdmin: false,
                            createdAt: serverTimestamp(),
                            customUIBgColor: '#ffffff',
                            customUITextColor: '#000000',
                            customUISecondaryTextColor: '#71717a', // NEW
                            customUISecondaryBgColor: '#e7e5e4', // NEW
                            customMainBgType: 'color',
                            customMainBgValue: '#FFFFFF',
                            // Initialize new settings for new profiles
                            currentThemeName: 'default',
                            customThemePresets: { slot1: { name: '', theme: null }, slot2: { name: '', theme: null }, slot3: { name: '', theme: null } },
                            showOthersBubbleColors: true,
                            recentRooms: [],
                        };
                        await setDoc(userProfileRef, profileData);
                    }
                } catch (profileError) {
                    console.error("Error fetching or creating user profile:", profileError);
                    setErrorMessage("Failed to load or create user profile.");
                    await signOut(auth);
                    return;
                }

                // Update local states from profileData (Firestore is the source of truth)
                setDisplayUsername(profileData.displayUsername || loggedInUser.email.split('@')[0]);
                setDisplayName(profileData.displayName || profileData.displayUsername || loggedInUser.email.split('@')[0]);
                setProfilePictureUrl(profileData.profilePictureUrl || '');
                setProfileDecorationUrl(profileData.profileDecorationUrl || '');
                setTempProfileDecorationUrl(profileData.profileDecorationUrl || '');
                setProfileDecorationSize(profileData.profileDecorationSize || 100);
                setTempProfileDecorationSize(profileData.profileDecorationSize || 100);
                setMyBubbleBgColor(profileData.myBubbleBgColor || '');
                setMyBubbleTextColor(profileData.myBubbleTextColor || '');
                setBio(profileData.bio || '');
                setProfileBgFromColor(profileData.profileBgFromColor || '#ffffff');
                setProfileBgToColor(profileData.profileBgToColor || '#e0e0e0');
                setProfileBanner(profileData.profileBanner || '');
                setProfileTextColorProfile(profileData.profileTextColorProfile || '');
                setProfileBannerType(profileData.profileBannerType || 'color');
                setIsAdmin(profileData.isAdmin || false);
                setIsLoggedIn(true);
                setShowLoginModal(false);
                setSuccessMessage('login successful!');

                // Load new settings from profileData
                setCurrentThemeName(profileData.currentThemeName || 'default');
                setCustomThemeAccentColor(profileData.customThemeAccentColor || '#8b5cf6');
                setCustomUIBgColor(profileData.customUIBgColor || '#ffffff');
                setCustomUITextColor(profileData.customUITextColor || '#000000');
                setCustomUISecondaryTextColor(profileData.customUISecondaryTextColor || '#71717a'); // NEW
                setCustomUISecondaryBgColor(profileData.customUISecondaryBgColor || '#e7e5e4'); // NEW
                setCustomMainBgType(profileData.customMainBgType || 'color');
                setCustomMainBgValue(profileData.customMainBgValue || '#FFFFFF');
                setCustomThemePresets(profileData.customThemePresets || { slot1: { name: '', theme: null }, slot2: { name: '', theme: null }, slot3: { name: '', theme: null } });
                setShowOthersBubbleColors(profileData.showOthersBubbleColors !== undefined ? profileData.showOthersBubbleColors : true);
                setRecentRooms(profileData.recentRooms || []);
                
                console.log("Logged in user:", loggedInUser.email);

            } catch (error) {
              console.error('error during login:', error);
              setErrorMessage(`login failed: ${error.message}`);
            }
          };

          const handleJoinRoom = async (e, roomCode) => {
            if (e && e.preventDefault) {
              e.preventDefault();
            }
            setErrorMessage('');
            setSuccessMessage('');

            const codeToJoin = roomCode;

            if (!codeToJoin) {
              setErrorMessage('please enter a room code.');
              return;
            }

            if (!userId) { // Ensure user ID is available
                setErrorMessage('authentication error. please try again.');
                return;
            }

            console.log("handleJoinRoom: Start. Joining room:", codeToJoin, "Current isLoggedIn:", isLoggedIn, "Current userId:", userId);

            // Check for global ban
            const banDocRef = doc(db, `artifacts/${appId}/public/data/bannedUsers`, userId);
            try {
                const banSnap = await getDoc(banDocRef);
                if (banSnap.exists()) {
                    const banData = banSnap.data();
                    const banUntilTime = banData.banUntil?.toDate().getTime();
                    if (banUntilTime && Date.now() < banUntilTime) {
                        setErrorMessage(`you are temporarily banned until ${new Date(banUntilTime).toLocaleTimeString()}.`);
                        return; // Prevent joining if banned
                    } else {
                        // Ban expired, clean up
                        await deleteDoc(banDocRef).catch(console.error);
                    }
                }
            } catch (error) {
                console.error("Error checking ban status:", error);
                setErrorMessage("failed to check ban status.");
                return;
            }

            // Check for room-specific kick
            const kickDocRef = doc(db, `artifacts/${appId}/public/data/chatRooms/${codeToJoin}/kickedUsers`, userId);
            try {
                const kickSnap = await getDoc(kickDocRef);
                if (kickSnap.exists()) {
                    setErrorMessage(`you have been kicked from room '${codeToJoin}'.`);
                    return; // Prevent joining if kicked
                }
            } catch (error) {
                console.error("Error checking kick status:", error);
                setErrorMessage("failed to check kick status.");
                return;
            }

            // Update recent rooms logic for chatrooms only - now done via Firestore saveUserSettingsToFirestore
            if (!codeToJoin.includes('_')) { // Only add to recent rooms if it's a public chatroom
                setRecentRooms(prevRecentRooms => {
                    const updatedRooms = [codeToJoin, ...prevRecentRooms.filter(room => room !== codeToJoin)];
                    const limitedRooms = updatedRooms.slice(0, 5); // Keep max 5 recent rooms
                    // saveUserSettingsToFirestore will handle persistence
                    return limitedRooms;
                });
            }

            setActiveRoomCode(codeToJoin);
            setJoinRoomCode(''); // Clear the input field for custom room code
            setSuccessMessage(`joined room: ${codeToJoin}`);
            // Update user activity immediately upon joining
            updateUserActivity(codeToJoin, userId);
            // Log state after updates to see if they're queued correctly
            console.log("handleJoinRoom: End. Attempted to set activeRoomCode to", codeToJoin);
          };

          const handleSendMessage = async (e) => {
            e.preventDefault();
            if (!newMessageText.trim() || !activeRoomCode || !userId || !displayUsername) {
              return;
            }

            // Clear typing status immediately upon sending message
            updateTypingStatus(false);
            if (typingTimeoutRef.current) {
                clearTimeout(typingTimeoutRef.current);
                typingTimeoutRef.current = null;
            }

            // Prevent sending messages if banned globally
            const banDocRef = doc(db, `artifacts/${appId}/public/data/bannedUsers`, userId);
            try {
                const banSnap = await getDoc(banDocRef);
                if (banSnap.exists()) {
                    const banData = banSnap.data();
                    const banUntilTime = banData.banUntil?.toDate().getTime();
                    if (banUntilTime && Date.now() < banUntilTime) {
                        setErrorMessage(`you cannot send messages: you are temporarily banned until ${new Date(banUntilTime).toLocaleTimeString()}.`);
                        return;
                    } else {
                        await deleteDoc(banDocRef).catch(console.error); // Clear expired ban
                    }
                }
            } catch (error) {
                console.error("Error checking ban status for message send:", error);
                setErrorMessage("failed to send message (ban check error).");
                return;
            }

            // Prevent sending messages if kicked from current room (only for public rooms)
            const isDM = activeRoomCode.includes('_');
            if (!isDM) {
                const kickDocRef = doc(db, `artifacts/${appId}/public/data/chatRooms/${activeRoomCode}/kickedUsers`, userId);
                try {
                    const kickSnap = await getDoc(kickDocRef);
                    if (kickSnap.exists()) {
                        setErrorMessage(`you cannot send messages: you have been kicked from room '${activeRoomCode}'.`);
                        return;
                    }
                } catch (error) {
                    console.error("Error checking kick status for message send:", error);
                    setErrorMessage("failed to send message (kick check error).");
                    return;
                }
            }


            const messagesPath = isDM
                ? `artifacts/${appId}/public/data/dmRooms/${activeRoomCode}/messages`
                : `artifacts/${appId}/public/data/chatRooms/${activeRoomCode}/messages`;

            try {
              const messagesCollectionRef = collection(db, messagesPath);
              await addDoc(messagesCollectionRef, {
                text: newMessageText.trim(),
                senderId: userId,
                senderUsername: displayUsername, // Save actual displayUsername
                senderDisplayName: displayName, // Save display name
                senderProfilePictureUrl: profilePictureUrl, // Save profile picture URL
                senderProfileDecorationUrl: profileDecorationUrl, // Save committed profile decoration URL
                senderProfileDecorationSize: profileDecorationSize, // Save committed profile decoration size
                senderBubbleColor: myBubbleBgColor, // Save sender's custom bubble color
                senderBubbleTextColor: myBubbleTextColor, // Save sender's custom bubble text color
                isAdmin: isAdmin, // Include isAdmin status when sending message
                readBy: { [userId]: true }, // Initialize readBy with sender's own ID
                timestamp: serverTimestamp(),
              });
              setNewMessageText('');
              // Update user activity on message send
              updateUserActivity(activeRoomCode, userId);
              // Force scroll to bottom immediately after sending a message
              setTimeout(() => { // Add a small delay to ensure rendering
                  if (messagesEndRef.current) {
                      messagesEndRef.current.scrollIntoView({ behavior: 'smooth' });
                  }
              }, 100);
            } catch (error) {
              console.error("error sending message:", error);
              setErrorMessage("failed to send message.");
            }
          };

          const handleLogout = async () => {
            setErrorMessage('');
            setSuccessMessage('');
            try {
              // Clear typing status on logout
              if (activeRoomCode && userId) {
                await updateTypingStatus(false);
              }
              await signOut(auth);
              setSuccessMessage('logged out successfully.');
              // Clear all local storage items related to user session
              localStorage.removeItem('chat_display_username');
              localStorage.removeItem('chat_display_name');
              localStorage.removeItem('chat_profile_picture_url');
              localStorage.removeItem('chat_profile_decoration_url');
              localStorage.removeItem('chat_profile_decoration_size');
              localStorage.removeItem('chat_bubble_bg_color');
              localStorage.removeItem('chat_bubble_text_color');
              localStorage.removeItem('chat_bio');
              localStorage.removeItem('chat_profile_bg_from_color');
              localStorage.removeItem('chat_profile_bg_to_color');
              localStorage.removeItem('chat_profile_banner');
              localStorage.removeItem('chat_profile_text_color');
              localStorage.removeItem('chat_profile_banner_type');
              localStorage.removeItem('chat_custom_ui_bg_color');
              localStorage.removeItem('chat_custom_ui_text_color');
              localStorage.removeItem('chat_custom_ui_secondary_text_color'); // NEW
              localStorage.removeItem('chat_custom_ui_secondary_bg_color'); // NEW
              localStorage.removeItem('chat_custom_main_bg_type');
              localStorage.removeItem('chat_custom_main_bg_value');
              localStorage.removeItem('chat_theme'); // Clear theme from local storage as well
              localStorage.removeItem('chat_custom_theme_accent_color'); // Clear accent color from local storage
              localStorage.removeItem('chat_last_dismissed_announcement_id'); // Clear dismissed announcement ID
              // Note: Recent rooms, presets, and showOthersBubbleColors are now managed by Firestore
              // so no explicit local storage clearing for them here.
            } catch (error) {
              console.error("error logging out:", error);
              setErrorMessage(`logout failed: ${error.message}`);
            }
          };

          // Handle typing in the message input
          const handleNewMessageTextChange = (e) => {
            const text = e.target.value;
            setNewMessageText(text);

            // Update typing status in Firestore
            if (userId && activeRoomCode && isLoggedIn) {
                // If text is not empty and no typing timeout is active, set typing to true
                if (text.length > 0 && !typingTimeoutRef.current) {
                    updateTypingStatus(true);
                }

                // Clear existing timeout
                if (typingTimeoutRef.current) {
                    clearTimeout(typingTimeoutRef.current);
                }

                // Set a new timeout to set typing to false after 3 seconds of inactivity
                typingTimeoutRef.current = setTimeout(() => {
                    updateTypingStatus(false);
                    typingTimeoutRef.current = null;
                }, 3000); // 3 seconds debounce
            }
          };

          const handleUpdateProfile = async (e) => {
            e.preventDefault();
            setErrorMessage('');
            setSuccessMessage('');

            const newProfilePictureUrl = profilePictureUrl.trim();
            const newBio = bio.trim();
            const newDisplayUsername = displayUsername.trim(); // Now refers to the public username
            const newDisplayName = displayName.trim();
            const newEmail = userEmail.trim(); // New: Email from input

            console.log("handleUpdateProfile: Captured newBio:", newBio);

            if (!newDisplayUsername) {
              setErrorMessage('public username cannot be empty.');
              return;
            }
            if (!newEmail) {
                setErrorMessage('email cannot be empty.');
                return;
            }

            try {
                // 1. Handle Email Update (if changed)
                if (auth.currentUser && newEmail !== auth.currentUser.email) {
                    try {
                        await updateEmail(auth.currentUser, newEmail);
                        setUserEmail(newEmail); // Update local state immediately
                        setSuccessMessage('email updated successfully! you might need to re-log in.');
                    } catch (emailError) {
                        console.error('Error updating email:', emailError);
                        // Specific Firebase error codes for re-authentication
                        if (emailError.code === 'auth/requires-recent-login') {
                            setErrorMessage('to change your email, please log out and log back in to re-authenticate.');
                        } else {
                            setErrorMessage(`failed to update email: ${emailError.message}`);
                        }
                        return; // Stop further updates if email update fails
                    }
                }

                // 2. Update the user's private profile document in Firestore
                const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/userProfiles`, userId);
                await setDoc(userProfileRef, {
                    email: newEmail, // Ensure email is also saved in Firestore profile
                    displayUsername: newDisplayUsername,
                    displayName: newDisplayName || newDisplayUsername, // Update display name, fallback to public username
                    profilePictureUrl: newProfilePictureUrl,
                    myBubbleBgColor: myBubbleBgColor,
                    myBubbleTextColor: myBubbleTextColor,
                    bio: newBio,
                    profileBgFromColor: profileBgFromColor,
                    profileBgToColor: profileBgToColor,
                    profileBanner: profileBanner,
                    profileTextColorProfile: profileTextColorProfile,
                    profileBannerType: profileBannerType,
                    // NEW: Save new custom UI theme settings to profile
                    customUIBgColor: customUIBgColor,
                    customUITextColor: customUITextColor,
                    customUISecondaryTextColor: customUISecondaryTextColor, // NEW
                    customUISecondaryBgColor: customUISecondaryBgColor, // NEW
                    customMainBgType: customMainBgType,
                    customMainBgValue: customMainBgValue,
                    // Save new settings to Firestore during profile update
                    currentThemeName: currentThemeName,
                    customThemePresets: customThemePresets,
                    showOthersBubbleColors: showOthersBubbleColors,
                    recentRooms: recentRooms,
                }, { merge: true });

                // Update local states and local storage (local storage for redundancy)
                setDisplayUsername(newDisplayUsername);
                setDisplayName(newDisplayName || newDisplayUsername);
                setProfilePictureUrl(newProfilePictureUrl);
                setBio(newBio);

                localStorage.setItem('chat_display_username', newDisplayUsername);
                localStorage.setItem('chat_display_name', newDisplayName || newDisplayUsername);
                localStorage.setItem('chat_profile_picture_url', newProfilePictureUrl);
                localStorage.setItem('chat_bio', newBio);
                localStorage.setItem('chat_profile_bg_from_color', profileBgFromColor);
                localStorage.setItem('chat_profile_bg_to_color', profileBgToColor);
                localStorage.setItem('chat_profile_banner', profileBanner);
                localStorage.setItem('chat_profile_text_color', profileTextColorProfile);
                localStorage.setItem('chat_profile_banner_type', profileBannerType);
                localStorage.setItem('chat_custom_ui_bg_color', customUIBgColor);
                localStorage.setItem('chat_custom_ui_text_color', customUITextColor);
                localStorage.setItem('chat_custom_ui_secondary_text_color', customUISecondaryTextColor); // NEW
                localStorage.setItem('chat_custom_ui_secondary_bg_color', customUISecondaryBgColor); // NEW
                localStorage.setItem('chat_custom_main_bg_type', customMainBgType);
                localStorage.setItem('chat_custom_main_bg_value', customMainBgValue);
                localStorage.setItem('chat_theme', currentThemeName);
                localStorage.setItem('chat_custom_theme_accent_color', customThemeAccentColor);

                setSuccessMessage('profile updated successfully!');
                setShowProfileModal(false); // Close modal on success
            } catch (error) {
              console.error('error updating profile:', error);
              setErrorMessage(`failed to update profile: ${error.message}`);
            }
          };

          const handleThemeChange = (themeName) => {
            setCurrentThemeName(themeName);
            // saveUserSettingsToFirestore() will be triggered by useEffect
            setSuccessMessage(`theme changed to '${themes[themeName]?.name || "Custom"}'!`);
          };

          const handleBubbleColorSelect = async (bgColorValue) => {
            let selectedBg = bgColorValue;
            let selectedText = '';

            // If it's a Tailwind class string
            if (bgColorValue.startsWith('bg-')) {
                const option = bubbleColorOptions.find(opt => opt.bgClass === bgColorValue);
                selectedText = option ? option.textClass : 'text-black'; // Fallback text color
            } else if (bgColorValue.startsWith('#')) { // It's a hex color
                selectedText = getContrastingTextColor(bgColorValue);
            } else {
                // Fallback for unexpected values, perhaps default to theme's color
                selectedBg = currentTheme.myBubbleBg;
                selectedText = currentTheme.myBubbleText;
            }
            
            setMyBubbleBgColor(selectedBg);
            setMyBubbleTextColor(selectedText);

            // saveUserSettingsToFirestore() will be triggered by useEffect
            setSuccessMessage('bubble color saved!');
          };

          const handleToggleHoverToDelete = async () => {
            const newSetting = !hoverToDeleteEnabled;
            try {
                const adminSettingsRef = doc(db, `artifacts/${appId}/public/data/adminSettings`, 'general');
                await setDoc(adminSettingsRef, { hoverToDeleteEnabled: newSetting }, { merge: true });
                setHoverToDeleteEnabled(newSetting); // Update local state
                setSuccessMessage(`'hover to delete' feature ${newSetting ? 'enabled' : 'disabled'}.`);
            } catch (error) {
                setErrorMessage('failed to update hover to delete setting.');
                console.error('Error updating hoverToDeleteEnabled:', error);
            }
          };

          // Admin Tag Customization Handlers
          const handleToggleShowAdminTag = async () => {
            const newSetting = !showAdminTag;
            try {
                const adminSettingsRef = doc(db, `artifacts/${appId}/public/data/adminSettings`, 'general');
                await setDoc(adminSettingsRef, { showAdminTag: newSetting }, { merge: true });
                setShowAdminTag(newSetting);
                setSuccessMessage(`admin tag display ${newSetting ? 'enabled' : 'disabled'}.`);
            } catch (error) {
                setErrorMessage('failed to update admin tag display setting.');
                console.error('Error updating showAdminTag:', error);
            }
          };

          const handleAdminTagColorChange = async (e) => {
            const newColor = e.target.value;
            try {
                const adminSettingsRef = doc(db, `artifacts/${appId}/public/data/adminSettings`, 'general');
                await setDoc(adminSettingsRef, { adminTagColor: newColor }, { merge: true });
                setAdminTagColor(newColor);
                setSuccessMessage('admin tag color updated.');
            } catch (error) {
                setErrorMessage('failed to update admin tag color.');
                console.error('Error updating adminTagColor:', error);
            }
          };

          const handleAdminTagTextChange = async (e) => {
            const newText = e.target.value.trim().toLowerCase(); // Always store in lowercase
            if (!newText) {
                setErrorMessage('admin tag text cannot be empty.');
                return;
            }
            try {
                const adminSettingsRef = doc(db, `artifacts/${appId}/public/data/adminSettings`, 'general');
                await setDoc(adminSettingsRef, { adminTagText: newText }, { merge: true });
                setAdminTagText(newText);
                setSuccessMessage('admin tag text updated.');
            } catch (error) {
                setErrorMessage('failed to update admin tag text.');
                console.error('Error updating adminTagText:', error);
            }
          };


          const handleDeleteMessage = async (messageIdToDelete) => {
            if (!activeRoomCode || !messageIdToDelete) return;

            const isDM = activeRoomCode.includes('_');
            const messagesPath = isDM
                ? `artifacts/${appId}/public/data/dmRooms/${activeRoomCode}/messages`
                : `artifacts/${appId}/public/data/chatRooms/${activeRoomCode}/messages`;

            try {
                const messageRef = doc(db, messagesPath, messageIdToDelete);
                await deleteDoc(messageRef);
                setSuccessMessage('message deleted.');
            } catch (error) {
                setErrorMessage('failed to delete message.');
                console.error('Error deleting message:', error);
            }
          };

          const handleClearAllMessages = async () => {
            setShowConfirmClearModal(true);
          };

          const confirmClearAllMessages = async () => {
            setShowConfirmClearModal(false); // Close modal immediately

            if (!activeRoomCode) return;

            const isDM = activeRoomCode.includes('_');
            const messagesPath = isDM
                ? `artifacts/${appId}/public/data/dmRooms/${activeRoomCode}/messages`
                : `artifacts/${appId}/public/data/chatRooms/${activeRoomCode}/messages`;

            try {
                const messagesCollectionRef = collection(db, messagesPath);
                const q = query(messagesCollectionRef);
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    setSuccessMessage('no messages to clear.');
                    return;
                }

                const deletePromises = [];
                snapshot.docs.forEach((docToDelete) => {
                    deletePromises.push(deleteDoc(doc(db, messagesPath, docToDelete.id)));
                });

                await Promise.all(deletePromises);
                setSuccessMessage('all messages cleared successfully!');
                setMessages([]); // Immediately clear local state
            } catch (error) {
                console.error('error clearing all messages:', error);
                setErrorMessage('failed to clear all messages.');
            }
          };

          const cancelClearAllMessages = () => {
            setShowConfirmClearModal(false);
          };

          // Handler for custom theme accent color change
          const handleCustomThemeAccentColorChange = (e) => {
              const newColor = e.target.value;
              setCustomThemeAccentColor(newColor);
              // saveUserSettingsToFirestore() will be triggered by useEffect
          };
          // NEW: Handler for custom UI background color
          const handleCustomUIBgColorChange = (e) => {
              const newColor = e.target.value;
              setCustomUIBgColor(newColor);
              // saveUserSettingsToFirestore() will be triggered by useEffect
          };
          // NEW: Handler for custom UI secondary background color (for buttons)
          const handleCustomUISecondaryBgColorChange = (e) => {
              const newColor = e.target.value;
              setCustomUISecondaryBgColor(newColor);
          };
          // NEW: Handler for custom UI primary text color change
          const handleCustomUITextColorChange = (e) => {
              const newColor = e.target.value;
              setCustomUITextColor(newColor);
              // saveUserSettingsToFirestore() will be triggered by useEffect
          };
          // NEW: Handler for custom UI secondary text color change
          const handleCustomUISecondaryTextColorChange = (e) => {
              const newColor = e.target.value;
              setCustomUISecondaryTextColor(newColor);
              // saveUserSettingsToFirestore() will be triggered by useEffect
          };
          // NEW: Handler for custom main background type change
          const handleCustomMainBgTypeChange = (type) => {
              setCustomMainBgType(type);
              // saveUserSettingsToFirestore() will be triggered by useEffect
          };
          // NEW: Handler for custom main background value change
          const handleCustomMainBgValueChange = (e) => {
              const newValue = e.target.value;
              setCustomMainBgValue(newValue);
              // saveUserSettingsToFirestore() will be triggered by useEffect
          };

          // Preset handlers
          const savePreset = (slotKey, presetName) => {
            const currentThemeSettings = {
                currentThemeName,
                customThemeAccentColor,
                customUIBgColor,
                customUITextColor,
                customUISecondaryTextColor, // NEW
                customUISecondaryBgColor, // NEW
                customMainBgType,
                customMainBgValue,
                myBubbleBgColor,
                myBubbleTextColor, // Also save bubble colors as part of the theme
                showOthersBubbleColors, // Also save this toggle state
            };
            setCustomThemePresets(prevPresets => {
                const updatedPresets = {
                    ...prevPresets,
                    [slotKey]: { name: presetName, theme: currentThemeSettings }
                };
                // saveUserSettingsToFirestore will be triggered by this state change
                return updatedPresets;
            });
            setSuccessMessage(`theme saved to ${presetName || slotKey}!`);
          };

          const loadPreset = (slotKey) => {
            const preset = customThemePresets[slotKey].theme;
            if (preset) {
                setCurrentThemeName(preset.currentThemeName);
                setCustomThemeAccentColor(preset.customThemeAccentColor);
                setCustomUIBgColor(preset.customUIBgColor);
                setCustomUITextColor(preset.customUITextColor);
                setCustomUISecondaryTextColor(preset.customUISecondaryTextColor); // NEW
                setCustomUISecondaryBgColor(preset.customUISecondaryBgColor); // NEW
                setCustomMainBgType(preset.customMainBgType);
                setCustomMainBgValue(preset.customMainBgValue);
                setMyBubbleBgColor(preset.myBubbleBgColor);
                setMyBubbleTextColor(preset.myBubbleTextColor);
                setShowOthersBubbleColors(preset.showOthersBubbleColors);
                setSuccessMessage(`loaded theme '${customThemePresets[slotKey].name || slotKey}'.`);
            } else {
                setErrorMessage('no theme saved in this slot.');
            }
          };

          // Function to open a user's profile modal
          const handleOpenUserProfile = (profileId) => {
              setSelectedUserProfileId(profileId);
              setShowUserProfileModal(true);
          };

          // Function to add a friend
          const addFriend = async (friendId, friendDisplayName) => {
            if (!userId || !friendId || userId === friendId) {
                setErrorMessage('cannot add self or invalid user.');
                return;
            }
            try {
                const dmCode = generateDmRoomCode(userId, friendId);
                // Add friend to current user's friends list
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/friends`, friendId), {
                    addedAt: serverTimestamp(),
                    displayName: friendDisplayName || "Friend", // Store friend's display name
                    dmRoomCode: dmCode, // Store DM room code
                });
                // Add current user to friend's friends list (for bilateral friendship)
                await setDoc(doc(db, `artifacts/${appId}/users/${friendId}/friends`, userId), {
                    addedAt: serverTimestamp(),
                    displayName: displayName || displayUsername, // Store current user's display name
                    dmRoomCode: dmCode, // Store DM room code
                });
                setSuccessMessage(`${friendDisplayName || 'User'} added as friend!`);
                setShowUserProfileModal(false); // Close modal after adding
            } catch (error) {
                setErrorMessage(`failed to add friend: ${error.message}`);
                console.error("Error adding friend:", error);
            }
          };

          // Function to open a DM chat with a friend
          const handleOpenDm = (friendId, dmRoomCodeFromFriendList) => {
              // Prefer dmRoomCode from friend list, but generate if somehow missing or for robustness
              const dmCode = dmRoomCodeFromFriendList || generateDmRoomCode(userId, friendId);
              console.log("App: handleOpenDm called with friendId:", friendId, "dmRoomCode:", dmCode);
              setActiveRoomCode(dmCode); 
              setCurrentView('dms'); // Ensure we are in the DMs view when opening a DM
              setSuccessMessage(`opened DM with ${friendsList.find(f => f.id === friendId)?.displayName || 'friend'}.`);
          };

          // New: Function to initiate kick confirmation
          const promptKickUser = (user) => {
              setUserToKick(user);
              setShowConfirmKickModal(true);
          };

          // New: Function to perform kick
          const performKickUser = async () => {
              if (!userToKick || !activeRoomCode || !isAdmin) {
                  setErrorMessage("invalid kick request.");
                  return;
              }
              setErrorMessage('');
              setSuccessMessage('');

              try {
                  // Add user to kickedUsers subcollection for the current room
                  const kickedUserRef = doc(db, `artifacts/${appId}/public/data/chatRooms/${activeRoomCode}/kickedUsers`, userToKick.id);
                  await setDoc(kickedUserRef, {
                      kickedAt: serverTimestamp(),
                      kickedBy: userId, // Current admin's UID
                      reason: `kicked by ${displayName || displayUsername}`
                  });

                  // Remove user from active chatroom activity
                  const userActivityRef = doc(db, `artifacts/${appId}/public/data/chatroomActivity/${activeRoomCode}/users`, userToKick.id);
                  await deleteDoc(userActivityRef).catch(error => console.warn("Error deleting user activity after kick:", error));

                  setSuccessMessage(`${userToKick.displayName || userToKick.displayUsername} has been kicked from this room.`);
                  if (userToKick.id === userId) { // If admin kicks themselves
                      handleLogout();
                  } else {
                      // If the kicked user is the one currently viewing the active users modal,
                      // they will be affected by the kick check on message send or room re-join.
                      // For now, no explicit UI change for others except their removal from active list.
                  }
              } catch (error) {
                  console.error("Error kicking user:", error);
                  setErrorMessage(`failed to kick ${userToKick.displayName || userToKick.displayUsername}.`);
              } finally {
                  setShowConfirmKickModal(false);
                  setUserToKick(null);
              }
          };

          // New: Function to initiate ban confirmation
          const promptBanUser = (user) => {
              setUserToBan(user);
              setShowConfirmBanModal(true);
          };

          // New: Function to perform ban
          const performBanUser = async () => {
              if (!userToBan || !isAdmin) {
                  setErrorMessage("invalid ban request.");
                  return;
              }
              setErrorMessage('');
              setSuccessMessage('');

              const banDurationMinutes = 10;
              const banUntil = new Date(Date.now() + banDurationMinutes * 60 * 1000); // 10 minutes from now

              try {
                  // Add user to global bannedUsers collection
                  const bannedUserRef = doc(db, `artifacts/${appId}/public/data/bannedUsers`, userToBan.id);
                  await setDoc(bannedUserRef, {
                      bannedAt: serverTimestamp(),
                      bannedBy: userId, // Current admin's UID
                      banUntil: banUntil,
                      reason: `banned by ${displayName || displayUsername} for ${banDurationMinutes} minutes.`
                  });

                  // Attempt to sign out the banned user if they are online
                  // This will trigger onAuthStateChanged for them, which will then block login if banned.
                  // There's no direct way to force a signout on another client from Firestore alone.
                  // The system relies on the banned user's client-side checks on login/message send.
                  // If the banned user is the admin who initiated the ban, they will be logged out.
                  if (userToBan.id === userId) {
                      await signOut(auth);
                      setSuccessMessage(`you have banned yourself for ${banDurationMinutes} minutes.`);
                  } else {
                      setSuccessMessage(`${userToBan.displayName || userToBan.displayUsername} has been banned for ${banDurationMinutes} minutes.`);
                  }

                  // Also remove from all activity for immediate effect within the app for others
                  // (This is not strictly necessary for the ban, but good for active user list UI)
                  const activityCollectionRef = collection(db, `artifacts/${appId}/public/data/chatroomActivity`);
                  const userActivityInCurrentRoomRef = doc(db, `artifacts/${appId}/public/data/chatroomActivity/${activeRoomCode}/users`, userToBan.id);
                  await deleteDoc(userActivityInCurrentRoomRef).catch(error => console.warn("Error deleting banned user's activity in current room:", error));


              } catch (error) {
                  console.error("Error banning user:", error);
                  setErrorMessage(`failed to ban ${userToBan.displayName || userToBan.displayUsername}.`);
              } finally {
                  setShowConfirmBanModal(false);
                  setUserToBan(null);
              }
          };

          const cancelKickBan = () => {
              setShowConfirmKickModal(false);
              setUserToKick(null);
              setShowConfirmBanModal(false);
              setUserToBan(null);
          };

          // New: Function to initiate revert ban confirmation
          const promptRevertBan = (user) => {
              setUserToRevertBan(user);
              setShowConfirmRevertBanModal(true);
          };

          // New: Function to perform revert ban
          const performRevertBan = async () => {
              if (!userToRevertBan || !isAdmin) {
                  setErrorMessage("invalid revert ban request.");
                  return;
              }
              setErrorMessage('');
              setSuccessMessage('');

              try {
                  const bannedUserRef = doc(db, `artifacts/${appId}/public/data/bannedUsers`, userToRevertBan.id);
                  await deleteDoc(bannedUserRef);
                  setSuccessMessage(`ban for ${userToRevertBan.displayName || userToRevertBan.displayUsername} has been reverted.`);
              } catch (error) {
                  console.error("Error reverting ban:", error);
                  setErrorMessage(`failed to revert ban for ${userToRevertBan.displayName || userToRevertBan.displayUsername}.`);
              } finally {
                  setShowConfirmRevertBanModal(false);
                  setUserToRevertBan(null);
              }
          };

          const cancelRevertBan = () => {
              setShowConfirmRevertBanModal(false);
              setUserToRevertBan(null);
          };

          // NEW: Function to send a global announcement
          const handleSendGlobalAnnouncement = async (announcementText) => {
            if (!isAdmin || !announcementText.trim()) {
                setErrorMessage('only admins can send announcements, and the message cannot be empty.');
                return;
            }
            setErrorMessage('');
            setSuccessMessage('');

            try {
                const announcementRef = doc(db, `artifacts/${appId}/public/data/globalAnnouncements`, 'latestAnnouncement');
                // Generate a unique ID for this announcement so users can dismiss it
                const announcementId = `${Date.now()}-${userId}`;

                await setDoc(announcementRef, {
                    id: announcementId, // Unique ID for this announcement
                    text: announcementText.trim(),
                    senderId: userId,
                    senderDisplayName: displayName || displayUsername,
                    timestamp: serverTimestamp(),
                }, { merge: true }); // Use merge to keep other potential fields

                setSuccessMessage('global announcement sent!');
                setShowGlobalAnnouncement(true); // Ensure it's visible after sending a new one
                lastDismissedAnnouncementId.current = null; // Clear dismissal for new announcement
                localStorage.removeItem('chat_last_dismissed_announcement_id'); // Ensure all users see it if they reload
            } catch (error) {
                console.error('Error sending global announcement:', error);
                setErrorMessage('failed to send global announcement.');
            }
          };

          // Function to dismiss global announcement locally
          const dismissGlobalAnnouncement = () => {
            if (globalAnnouncement && globalAnnouncement.id) {
                lastDismissedAnnouncementId.current = globalAnnouncement.id;
                localStorage.setItem('chat_last_dismissed_announcement_id', globalAnnouncement.id);
            }
            setShowGlobalAnnouncement(false);
          };


          // Determine the bubble and text color classes for current user's messages
          // If myBubbleBgColor is a hex, use it directly in style
          const myMessageBubbleBg = myBubbleBgColor.startsWith('#') ? '' : (myBubbleBgColor || currentTheme.myBubbleBg);
          const myMessageBubbleBgStyle = myBubbleBgColor.startsWith('#') ? { backgroundColor: myBubbleBgColor } : {};
          const myMessageBubbleText = myBubbleTextColor || currentTheme.myBubbleText;

          // Formatting for typing indicator message
          const typingMessage = React.useMemo(() => {
            if (typingUsers.length === 0) return null;
            if (typingUsers.length === 1) {
              return (
                <span className="flex items-center text-sm italic lowercase" style={{color: currentTheme.secondaryText}}>
                    <img src={typingUsers[0].profilePictureUrl || 'https://placehold.co/16x16/cccccc/ffffff?text=P'} alt="PFP" className="w-4 h-4 rounded-full mr-2 object-cover" />
                    {typingUsers[0].displayName} is typing...
                </span>
              );
            }
            if (typingUsers.length === 2) {
              return (
                <span className="flex items-center text-sm italic lowercase" style={{color: currentTheme.secondaryText}}>
                    <img src={typingUsers[0].profilePictureUrl || 'https://placehold.co/16x16/cccccc/ffffff?text=P'} alt="PFP" className="w-4 h-4 rounded-full mr-1 object-cover" />
                    <img src={typingUsers[1].profilePictureUrl || 'https://placehold.co/16x16/cccccc/ffffff?text=P'} alt="PFP" className="w-4 h-4 rounded-full mr-2 object-cover" />
                    {typingUsers[0].displayName} and {typingUsers[1].displayName} are typing...
                </span>
              );
            }
            if (typingUsers.length > 2) {
                const firstTwo = typingUsers.slice(0, 2);
                const remainingCount = typingUsers.length - 2;
                return (
                    <span className="flex items-center text-sm italic lowercase" style={{color: currentTheme.secondaryText}}>
                        {firstTwo.map((user, index) => (
                            <img key={index} src={user.profilePictureUrl || 'https://placehold.co/16x16/cccccc/ffffff?text=P'} alt="PFP" className="w-4 h-4 rounded-full mr-1 object-cover" />
                        ))}
                        {firstTwo[0].displayName}, {firstTwo[1].displayName}, and {remainingCount} other{remainingCount > 1 ? 's' : ''} are typing...
                    </span>
                );
            }
            return null; // Should not happen
          }, [typingUsers, currentTheme.secondaryText]);

          // Function to open the info modal
          const openInfoModal = (title, message, imageUrl = '') => {
            setInfoModalContent({ title, message, imageUrl });
            setShowInfoModal(true);
          };


          // Logging for overall App render conditions
          console.log("App Render cycle. isLoggedIn:", isLoggedIn, "activeRoomCode:", activeRoomCode, "showLoginModal:", showLoginModal, "showRegisterModal:", showRegisterModal, "isAdmin:", isAdmin);

          if (!isAuthReady) {
            return (
              <div className="flex items-center justify-center min-h-screen bg-stone-100 font-inter">
                <p className="text-xl text-stone-700">loading chatroom...</p>
              </div>
            );
          }

          const isDMActive = activeRoomCode.includes('_');

          return (
            <div
                className={`min-h-screen flex flex-col items-center justify-center p-4 font-inter ${currentTheme.mainBgClass}`}
                style={{
                    ...(currentTheme.mainBgColorStyle ? { backgroundColor: currentTheme.mainBgColorStyle } : {}),
                    ...currentTheme.mainBgImageStyle
                }}
            >
              {errorMessage && (
                <div className="absolute top-4 left-1/2 -translate-x-1/2 bg-stone-800 text-white p-3 rounded-lg shadow-lg flex items-center justify-between z-50">
                  <span className="lowercase">{errorMessage}</span>
                  <button onClick={() => setErrorMessage('')} className="ml-4 font-bold text-lg leading-none">&times;</button>
                </div>
              )}
              {successMessage && (
                <div className="absolute top-4 left-1/2 -translate-x-1/2 bg-stone-600 text-white p-3 rounded-lg shadow-lg flex items-center justify-between z-50">
                  <span className="lowercase">{successMessage}</span>
                  <button onClick={() => setSuccessMessage('')} className="ml-4 font-bold text-lg leading-none">&times;</button>
                </div>
              )}

              {/* NEW: Global Announcement Display */}
              {globalAnnouncement && showGlobalAnnouncement && (
                <div className="w-full max-w-4xl bg-yellow-200 text-yellow-900 p-3 rounded-lg shadow-md mb-6 flex items-start justify-between">
                    <p className="font-semibold text-sm lowercase">
                        <span className="font-bold uppercase mr-2">[announcement by {globalAnnouncement.senderDisplayName || 'admin'}]</span>
                        {globalAnnouncement.text}
                    </p>
                    <button onClick={dismissGlobalAnnouncement} className="ml-4 font-bold text-lg leading-none text-yellow-800">&times;</button>
                </div>
              )}

              {/* main title */}
              <h1 className={`text-5xl font-extrabold mb-8 ${currentTheme.textColor} lowercase text-center`}>coffee shop chatrooms</h1>

              {/* Display current User ID for debugging/identification */}
              {userId && (
                <p className={`text-sm ${currentTheme.secondaryText} mb-4 lowercase`}>your user id: <span className="font-mono">{userId}</span></p>
              )}


              {/* login modal */}
              {(!isLoggedIn || showLoginModal) && !showRegisterModal && (
                <div className={`${currentTheme.chatBg} p-8 rounded-xl shadow-2xl w-full max-w-md text-center`}>
                  <h2 className={`text-3xl font-bold mb-6 ${currentTheme.textColor} lowercase`}>welcome back!</h2>
                  <form onSubmit={handleLogin} className="space-y-4">
                    <input
                      type="email" // Changed to email type
                      value={loginEmail}
                      onChange={(e) => setLoginEmail(e.target.value)}
                      placeholder="email"
                      className={`w-full p-3 border ${currentTheme.inputBorder} rounded-lg focus:ring-2 ${currentTheme.inputFocus} outline-none ${currentTheme.inputBg} ${currentTheme.inputTextColor}`}
                      required
                    />
                    <input
                      type="password"
                      value={loginPassword}
                      onChange={(e) => setLoginPassword(e.target.value)}
                      placeholder="password"
                      className={`w-full p-3 border ${currentTheme.inputBorder} rounded-lg focus:ring-2 ${currentTheme.inputFocus} outline-none ${currentTheme.inputBg} ${currentTheme.inputTextColor}`}
                      required
                    />
                    <button
                      type="submit"
                      className={`w-full ${currentTheme.buttonPrimaryBg} ${currentTheme.buttonPrimaryText} p-3 rounded-lg font-semibold ${currentTheme.buttonPrimaryHover} transition duration-300 shadow-md lowercase`}
                    >
                      log in
                    </button>
                  </form>
                  <p className={`mt-6 ${currentTheme.secondaryText} lowercase`}>
                    don't have an account?{' '}
                    <button
                      onClick={() => { setShowRegisterModal(true); setShowLoginModal(false); setErrorMessage(''); setSuccessMessage(''); }}
                      className={`${currentTheme.secondaryText} hover:underline font-medium`}
                    >
                      register here
                    </button>
                  </p>
                </div>
              )}

              {/* register modal */}
              {showRegisterModal && (
                <div className={`${currentTheme.chatBg} p-8 rounded-xl shadow-2xl w-full max-w-md text-center`}>
                  <h2 className={`text-3xl font-bold mb-6 ${currentTheme.textColor} lowercase`}>create account</h2>
                  <form onSubmit={handleRegister} className="space-y-4">
                    <input
                      type="email" // Changed to email type
                      value={registerEmail}
                      onChange={(e) => setRegisterEmail(e.target.value)}
                      placeholder="choose email"
                      className={`w-full p-3 border ${currentTheme.inputBorder} rounded-lg focus:ring-2 ${currentTheme.inputFocus} outline-none ${currentTheme.inputBg} ${currentTheme.inputTextColor}`}
                      required
                    />
                    <input
                      type="password"
                      value={registerPassword}
                      onChange={(e) => setRegisterPassword(e.target.value)}
                      placeholder="choose password"
                      className={`w-full p-3 border ${currentTheme.inputBorder} rounded-lg focus:ring-2 ${currentTheme.inputFocus} outline-none ${currentTheme.inputBg} ${currentTheme.inputTextColor}`}
                      required
                    />
                    <input
                      type="text" // New field for display name
                      value={registerDisplayName}
                      onChange={(e) => setRegisterDisplayName(e.target.value)}
                      placeholder="choose display name (e.g. 'CoffeeLover')"
                      className={`w-full p-3 border ${currentTheme.inputBorder} rounded-lg focus:ring-2 ${currentTheme.inputFocus} outline-none ${currentTheme.inputBg} ${currentTheme.inputTextColor}`}
                      required
                    />
                    <button
                      type="submit"
                      className={`w-full ${currentTheme.buttonSecondaryBg} ${currentTheme.buttonSecondaryText} p-3 rounded-lg font-semibold ${currentTheme.buttonSecondaryHover} transition duration-300 shadow-md lowercase`}
                    >
                      register
                    </button>
                  </form>
                  <p className={`mt-6 ${currentTheme.secondaryText} lowercase`}>
                    already have an account?{' '}
                    <button
                      onClick={() => { setShowRegisterModal(false); setShowLoginModal(true); setErrorMessage(''); setSuccessMessage(''); }}
                      className={`${currentTheme.secondaryText} hover:underline font-medium`}
                    >
                      log in
                    </button>
                  </p>
                </div>
              )}

              {/* Main chat UI: Conditional rendering based on activeRoomCode and isDMActive */}
              {isLoggedIn && (
                <>
                  {/* Initial Room/DM Selection UI */}
                  {!activeRoomCode && (
                    <div className={`${currentTheme.chatBg} p-6 rounded-xl shadow-2xl w-full max-w-5xl h-[70vh] flex flex-col md:flex-row gap-6 relative`}>
                      {/* Profile Settings Gear icon */}
                      <button
                        onClick={() => setShowProfileModal(true)}
                        className={`absolute top-4 right-4 ${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} p-3 rounded-full shadow-md ${currentTheme.buttonTertiaryHover} transition duration-300 z-10`}
                        title="Profile Settings"
                      >
                        <i className="fas fa-cog text-xl"></i>
                      </button>

                      <button
                        onClick={() => setShowChatSettingsModal(true)}
                        className={`absolute top-4 right-20 ${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} p-3 rounded-full shadow-md ${currentTheme.buttonTertiaryHover} transition duration-300 z-10`}
                        title="Chat Settings"
                      >
                        <i className="fas fa-paint-brush text-xl"></i>
                      </button>

                      {/* Admin Panel Button (Conditional) */}
                      {isAdmin && (
                        <button
                          onClick={() => setShowAdminPanelModal(true)}
                          className={`absolute top-4 right-36 ${currentTheme.buttonSecondaryBg} ${currentTheme.buttonSecondaryText} p-3 rounded-full shadow-md ${currentTheme.buttonSecondaryHover} transition duration-300 z-10`}
                          title="Admin Panel"
                        >
                          <i className="fas fa-shield-alt text-xl"></i>
                        </button>
                      )}

                      {/* View Toggle (Chatrooms vs DMs) */}
                      <div className="absolute top-4 left-4 flex space-x-2">
                        <button
                          onClick={() => { setCurrentView('chatrooms'); setActiveRoomCode(''); setMessages([]); }}
                          className={`px-4 py-2 rounded-lg font-semibold lowercase ${
                            currentView === 'chatrooms' ? `${currentTheme.buttonPrimaryBg} ${currentTheme.buttonPrimaryText}` : `${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} ${currentTheme.buttonTertiaryHover}`
                          } transition duration-200`}
                        >
                          chatrooms
                        </button>
                        <button
                          onClick={() => { setCurrentView('dms'); setActiveRoomCode(''); setMessages([]); }}
                          className={`px-4 py-2 rounded-lg font-semibold lowercase ${
                            currentView === 'dms' ? `${currentTheme.buttonPrimaryBg} ${currentTheme.buttonPrimaryText}` : `${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} ${currentTheme.buttonTertiaryHover}`
                          } transition duration-200`}
                        >
                          dms
                        </button>
                      </div>

                      {/* Left Panel: Predefined Chatrooms */}
                      <div className={`flex-1 ${currentTheme.messagesBg} p-6 rounded-lg overflow-y-auto ${currentTheme.scrollbar}`} style={currentTheme.scrollbarVars}>
                        {currentView === 'chatrooms' ? (
                          <>
                            <h2 className={`text-2xl font-bold mb-4 ${currentTheme.textColor} lowercase text-center pt-16`}>join a chatroom</h2>
                            <div className="space-y-3">
                              {predefinedChatrooms.map((room) => (
                                <button
                                  key={room.name}
                                  onClick={(e) => handleJoinRoom(e, room.name)}
                                  className={`w-full text-left p-3 rounded-lg ${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} font-semibold ${currentTheme.buttonTertiaryHover} transition duration-200 shadow-sm lowercase`}
                                >
                                  # {room.label}
                                </button>
                              ))}
                            </div>
                          </>
                        ) : (
                            <p className={`${currentTheme.secondaryText} text-center mt-8 lowercase`}>select a direct message from the right panel.</p>
                        )}
                      </div>

                      {/* Right Panel: Conditional Content (Custom Code + Recent Chats OR DMs) */}
                      <div className={`flex-1 ${currentTheme.chatBg} p-6 rounded-lg flex flex-col justify-between`}>
                        {currentView === 'chatrooms' && (
                          <div>
                            <h2 className={`text-2xl font-bold mb-4 ${currentTheme.textColor} lowercase text-center pt-16`}>enter a custom code</h2>
                            <form onSubmit={(e) => handleJoinRoom(e, joinRoomCode)} className="space-y-4">
                              <input
                                type="text"
                                value={joinRoomCode}
                                onChange={(e) => setJoinRoomCode(e.target.value)}
                                placeholder="enter room code (e.g., my-secret-spot)"
                                className={`w-full p-3 border ${currentTheme.inputBorder} rounded-lg focus:ring-2 ${currentTheme.inputFocus} outline-none ${currentTheme.inputBg} ${currentTheme.inputTextColor}`}
                                required
                              />
                              <button
                                type="submit"
                                className={`w-full ${currentTheme.buttonPrimaryBg} ${currentTheme.buttonPrimaryText} p-3 rounded-lg font-semibold ${currentTheme.buttonPrimaryHover} transition duration-300 shadow-md lowercase`}
                              >
                                join custom room
                              </button>
                            </form>
                            {recentRooms.length > 0 && (
                              <div className={`mt-8 pt-4 border-t ${currentTheme.inputBorder} max-h-[200px] overflow-y-auto ${currentTheme.scrollbar}`} style={currentTheme.scrollbarVars}>
                                <h3 className={`text-xl font-bold mb-4 ${currentTheme.textColor} lowercase text-center`}>recently entered chats</h3>
                                <div className={`space-y-2`}>
                                  {recentRooms.map((roomCode) => (
                                    <button
                                      key={roomCode}
                                      onClick={(e) => handleJoinRoom(e, roomCode)}
                                      className={`w-full text-left p-3 rounded-lg ${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} font-semibold ${currentTheme.buttonTertiaryHover} transition duration-200 shadow-sm lowercase`}
                                    >
                                      # {roomCode}
                                    </button>
                                  ))}
                                </div>
                              </div>
                            )}
                          </div>
                        )}
                        
                        {currentView === 'dms' && (
                          <div className={`flex-1 overflow-y-auto ${currentTheme.scrollbar}`} style={currentTheme.scrollbarVars}>
                              <h2 className={`text-2xl font-bold mb-4 ${currentTheme.textColor} lowercase text-center pt-16`}>your direct messages</h2>
                              {friendsList.length === 0 ? (
                                <p className={`${currentTheme.secondaryText} text-center mt-8 lowercase`}>you have no friends yet. click on a user's name in a chatroom to add them!</p>
                              ) : (
                                <div className={`space-y-3`}>
                                  {friendsList.map((friend) => (
                                    <button
                                      key={friend.id}
                                      onClick={() => handleOpenDm(friend.id, friend.dmRoomCode)}
                                      className={`w-full text-left p-3 rounded-lg ${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} font-semibold ${currentTheme.buttonTertiaryHover} transition duration-200 shadow-sm lowercase flex items-center`}
                                    >
                                      <img
                                        src={friend.profilePictureUrl || 'https://placehold.co/32x32/cccccc/ffffff?text=P'}
                                        alt="PFP"
                                        className="w-8 h-8 rounded-full mr-3 object-cover"
                                      />
                                      {friend.displayName || friend.displayUsername || 'anonymous'}
                                    </button>
                                  ))}
                                </div>
                              )}
                            </div>
                        )}

                        {/* Removed: Logout button from here */}
                      </div>
                    </div>
                  )}

                  {/* CHATROOM UI (FULL SCREEN) */}
                  {activeRoomCode && !isDMActive && (
                    <div
                      key={activeRoomCode} /* Added key for re-initialization on room change */
                      className={`${currentTheme.chatBg} p-6 rounded-xl shadow-2xl w-full max-w-6xl flex flex-col h-[80vh] md:h-[calc(100vh-80px)] relative`}
                    >
                      <div className={`flex justify-between items-center mb-4 pb-4 border-b ${currentTheme.inputBorder}`}>
                        <h2 className={`text-2xl font-bold ${currentTheme.textColor} lowercase`}>
                          <span className={`${currentTheme.secondaryText}`}>room: </span>
                          {activeRoomCode}
                        </h2>
                        <div className="flex items-center space-x-3">
                          <span className={`${currentTheme.secondaryText} text-sm lowercase`}>logged in as <span className="font-semibold">{displayName}</span></span>
                          <button
                            onClick={() => setShowChatSettingsModal(true)}
                            className={`${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} p-3 rounded-full shadow-md ${currentTheme.buttonTertiaryHover} transition duration-300 z-10`}
                            title="Chat Settings"
                          >
                            <i className="fas fa-paint-brush text-xl"></i>
                          </button>
                          {/* New button for Active Users */}
                          <button
                            onClick={() => setShowActiveUsersModal(true)}
                            className={`${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} p-3 rounded-full shadow-md ${currentTheme.buttonTertiaryHover} transition duration-300 z-10`}
                            title="Active Users"
                          >
                            <i className="fas fa-users text-xl"></i>
                          </button>
                          <button
                            onClick={() => { setActiveRoomCode(''); setMessages([]); setCurrentView('chatrooms'); }}
                            className={`${currentTheme.buttonSecondaryBg} ${currentTheme.buttonSecondaryText} px-4 py-2 rounded-lg text-sm font-semibold ${currentTheme.buttonSecondaryHover} transition duration-300 shadow-md lowercase`}
                          >
                            leave room
                          </button>
                          {/* Removed: Logout button from here */}
                          {isAdmin ? (
                            <button
                                onClick={handleClearAllMessages}
                                className={`bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-600 transition duration-300 shadow-md lowercase`}
                                title="Clear All Messages"
                            >
                                clear all
                            </button>
                          ) : null}
                        </div>
                      </div>

                      <div ref={messagesContainerRef} className={`flex-1 overflow-y-auto pr-2 ${currentTheme.scrollbar}`} style={currentTheme.scrollbarVars}>
                        {messages.length === 0 ? (
                          <p className={`${currentTheme.secondaryText} text-center mt-8 lowercase bg-yellow-100 p-4 rounded-lg`}>
                            no messages yet. be the first to send one!
                          </p>
                        ) : (
                          messages.map((msg) => (
                            <MessageItem
                              key={msg.id}
                              msg={msg}
                              userId={userId}
                              appId={appId}
                              activeRoomCode={activeRoomCode}
                              db={db}
                              myMessageBubbleBg={myMessageBubbleBg}
                              myBubbleTextColor={myBubbleTextColor}
                              currentTheme={currentTheme}
                              profilePictureUrl={profilePictureUrl}
                              isAdmin={isAdmin}
                              hoverToDeleteEnabled={hoverToDeleteEnabled}
                              onDeleteMessage={handleDeleteMessage}
                              onOpenUserProfile={handleOpenUserProfile}
                              showAdminTag={showAdminTag} // Pass new props
                              adminTagColor={adminTagColor} // Pass new props
                              adminTagText={adminTagText} // Pass new props
                              showOthersBubbleColors={showOthersBubbleColors} // Pass new prop
                            />
                          ))
                        )}
                        <div ref={messagesEndRef} />
                      </div>
                      
                      {/* Typing indicator for chatrooms */}
                      <div className={`h-6 text-left ${currentTheme.textColor} mb-2`}>
                          {typingMessage}
                      </div>

                      <form onSubmit={handleSendMessage} className={`mt-4 flex items-center space-x-3 pt-4 border-t ${currentTheme.inputBorder}`}>
                        <input
                          type="text"
                          value={newMessageText}
                          onChange={handleNewMessageTextChange} // Updated to new handler
                          placeholder="type your message..."
                          className={`flex-1 p-3 border ${currentTheme.inputBorder} rounded-lg focus:ring-2 ${currentTheme.inputFocus} outline-none ${currentTheme.inputBg} ${currentTheme.inputTextColor}`}
                        />
                        <button
                          type="submit"
                          className={`w-auto px-6 py-3 ${currentTheme.buttonPrimaryBg} ${currentTheme.buttonPrimaryText} rounded-lg font-semibold ${currentTheme.buttonPrimaryHover} transition duration-300 shadow-md lowercase`}
                        >
                          send
                        </button>
                      </form>
                    </div>
                  )}

                  {/* DM CHAT UI (TWO PANELS - Left for messages, Right for DM list) */}
                  {activeRoomCode && isDMActive && (
                    <div className={`${currentTheme.chatBg} p-6 rounded-xl shadow-2xl w-full max-w-6xl flex h-[80vh] md:h-[calc(100vh-80px)] relative`}>
                        {/* Profile Settings Gear icon - only here for active chats */}
                        <button
                            onClick={() => setShowProfileModal(true)}
                            className={`absolute top-4 right-4 ${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} p-3 rounded-full shadow-md ${currentTheme.buttonTertiaryHover} transition duration-300 z-10`}
                            title="Profile Settings"
                        >
                            <i className="fas fa-cog text-xl"></i>
                        </button>
                        
                        <button
                            onClick={() => setShowChatSettingsModal(true)}
                            className={`absolute top-4 right-20 ${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} p-3 rounded-full shadow-md ${currentTheme.buttonTertiaryHover} transition duration-300 z-10`}
                            title="Chat Settings"
                        >
                            <i className="fas fa-paint-brush text-xl"></i>
                        </button>

                        {/* Admin Panel Button (Conditional) */}
                        {isAdmin && (
                            <button
                                onClick={() => setShowAdminPanelModal(true)}
                                className={`absolute top-4 right-36 ${currentTheme.buttonSecondaryBg} ${currentTheme.buttonSecondaryText} p-3 rounded-full shadow-md ${currentTheme.buttonSecondaryHover} transition duration-300 z-10`}
                                title="Admin Panel"
                            >
                                <i className="fas fa-shield-alt text-xl"></i>
                            </button>
                        )}
                        
                        {/* LEFT PANEL: Message Display and Input for DM */}
                        <div className={`flex-1 flex flex-col ${currentTheme.messagesBg} p-4 rounded-lg`}>
                            <div className={`flex justify-between items-center mb-4 pb-4 border-b ${currentTheme.inputBorder}`}>
                                <h2 className={`text-2xl font-bold ${currentTheme.textColor} lowercase`}>
                                    <span className={`${currentTheme.secondaryText}`}>dm with: </span>
                                    {friendsList.find(f => f.dmRoomCode === activeRoomCode)?.displayName || 'friend'}
                                </h2>
                                <div className="flex items-center space-x-3">
                                    <span className={`${currentTheme.secondaryText} text-sm lowercase`}>logged in as <span className="font-semibold">{displayName}</span></span>
                                    <button
                                        onClick={() => setShowChatSettingsModal(true)}
                                        className={`${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} p-3 rounded-full shadow-md ${currentTheme.buttonTertiaryHover} transition duration-300 z-10`}
                                        title="Chat Settings"
                                    >
                                        <i className="fas fa-paint-brush text-xl"></i>
                                    </button>
                                    {/* New button for Active Users */}
                                    <button
                                        onClick={() => setShowActiveUsersModal(true)}
                                        className={`${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} p-3 rounded-full shadow-md ${currentTheme.buttonTertiaryHover} transition duration-300 z-10`}
                                        title="Active Users"
                                    >
                                        <i className="fas fa-users text-xl"></i>
                                    </button>
                                    <button
                                        onClick={() => { setActiveRoomCode(''); setMessages([]); setCurrentView('dms'); }}
                                        className={`${currentTheme.buttonSecondaryBg} ${currentTheme.buttonSecondaryText} px-4 py-2 rounded-lg text-sm font-semibold ${currentTheme.buttonSecondaryHover} transition duration-300 shadow-md lowercase`}
                                    >
                                        leave dm
                                    </button>
                                    {isAdmin ? (
                                        <button
                                            onClick={handleClearAllMessages}
                                            className={`bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-red-600 transition duration-300 shadow-md lowercase`}
                                            title="Clear All Messages"
                                        >
                                            clear all
                                        </button>
                                    ) : null}
                                </div>
                            </div>

                            <div ref={messagesContainerRef} className={`flex-1 overflow-y-auto pr-2 ${currentTheme.scrollbar}`} style={currentTheme.scrollbarVars}>
                                {messages.length === 0 ? (
                                    <p className={`${currentTheme.secondaryText} text-center mt-8 lowercase bg-yellow-100 p-4 rounded-lg`}>
                                        no messages yet. be the first to send one!
                                    </p>
                                ) : (
                                    messages.map((msg) => (
                                        <MessageItem
                                            key={msg.id}
                                            msg={msg}
                                            userId={userId}
                                            appId={appId}
                                            activeRoomCode={activeRoomCode}
                                            db={db}
                                            myMessageBubbleBg={myMessageBubbleBg}
                                            myBubbleTextColor={myBubbleTextColor}
                                            currentTheme={currentTheme}
                                            profilePictureUrl={profilePictureUrl}
                                            isAdmin={isAdmin}
                                            hoverToDeleteEnabled={hoverToDeleteEnabled}
                                            onDeleteMessage={handleDeleteMessage}
                                            onOpenUserProfile={handleOpenUserProfile}
                                            showAdminTag={showAdminTag} // Pass new props
                                            adminTagColor={adminTagColor} // Pass new props
                                            adminTagText={adminTagText} // Pass new props
                                            showOthersBubbleColors={showOthersBubbleColors} // Pass new prop
                                        />
                                    ))
                                )}
                                <div ref={messagesEndRef} />
                            </div>

                            {/* Typing indicator for DMs */}
                            <div className={`h-6 text-left ${currentTheme.textColor} mb-2`}>
                                {typingMessage}
                            </div>

                            <form onSubmit={handleSendMessage} className={`mt-4 flex items-center space-x-3 pt-4 border-t ${currentTheme.inputBorder}`}>
                                <input
                                    type="text"
                                    value={newMessageText}
                                    onChange={handleNewMessageTextChange} // Updated to new handler
                                    placeholder="type your message..."
                                    className={`flex-1 p-3 border ${currentTheme.inputBorder} rounded-lg focus:ring-2 ${currentTheme.inputFocus} outline-none ${currentTheme.inputBg} ${currentTheme.inputTextColor}`}
                                />
                                <button
                                    type="submit"
                                    className={`w-auto px-6 py-3 ${currentTheme.buttonPrimaryBg} ${currentTheme.buttonPrimaryText} rounded-lg font-semibold ${currentTheme.buttonPrimaryHover} transition duration-300 shadow-md lowercase`}
                                >
                                    send
                                </button>
                            </form>
                        </div>

                        {/* RIGHT PANEL: DM List always visible in DM view */}
                        <div className={`w-1/3 flex flex-col ${currentTheme.chatBg} p-4 rounded-lg ml-4`}>
                            <h3 className={`text-xl font-bold mb-4 ${currentTheme.textColor} lowercase text-center`}>your direct messages</h3>
                            {friendsList.length === 0 ? (
                                <p className={`${currentTheme.secondaryText} text-center mt-8 lowercase`}>you have no friends yet. click on a user's name in a chatroom to add them!</p>
                            ) : (
                                <div className={`space-y-3 flex-1 overflow-y-auto ${currentTheme.scrollbar}`} style={currentTheme.scrollbarVars}>
                                  {friendsList.map((friend) => (
                                    <button
                                      key={friend.id}
                                      onClick={() => handleOpenDm(friend.id, friend.dmRoomCode)}
                                      className={`w-full text-left p-3 rounded-lg ${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} font-semibold ${currentTheme.buttonTertiaryHover} transition duration-200 shadow-sm lowercase flex items-center`}
                                    >
                                      <img
                                        src={friend.profilePictureUrl || 'https://placehold.co/32x32/cccccc/ffffff?text=P'}
                                        alt="PFP"
                                        className="w-8 h-8 rounded-full mr-3 object-cover"
                                      />
                                      {friend.displayName || friend.displayUsername || 'anonymous'}
                                    </button>
                                  ))}
                                </div>
                            )}
                        </div>
                    </div>
                  )}
                </>
              )}

              {/* profile settings modal (FULL SCREEN) */}
              {showProfileModal && (
                <div className={`fixed inset-0 z-50 flex flex-col items-center justify-center ${currentTheme.mainBgClass}`} style={currentTheme.scrollbarVars}>
                  <div className={`${currentTheme.chatBg} rounded-xl shadow-2xl w-full max-w-5xl h-full p-8 flex flex-col lg:flex-row gap-8 text-center overflow-y-auto ${currentTheme.scrollbar}`} style={currentTheme.scrollbarVars}>
                    {/* Left Column: Profile Picture, Bio, and Preview */}
                    <div className="flex-1 flex flex-col items-center space-y-6 lg:border-r border-transparent lg:pr-8 pt-8">
                      <h2 className={`text-3xl font-bold ${currentTheme.textColor} lowercase`}>your profile</h2>
                      <div className="flex flex-col items-center w-full max-w-sm">
                        <label htmlFor="profilePictureUrlInput" className={`block text-center text-sm font-medium ${currentTheme.textColor} mb-2 lowercase`}>profile picture:</label>
                        <img src={profilePictureUrl || 'https://placehold.co/150x150/cccccc/ffffff?text=PFP'} alt="Profile Preview" className="w-40 h-40 rounded-full mx-auto object-cover border-4 border-stone-300 shadow-lg" onError={(e) => e.target.src='https://placehold.co/150x150/cccccc/ffffff?text=PFP'} />
                        <div className="relative w-full"> {/* Wrapper for input and info icon */}
                            <input
                              id="profilePictureUrlInput"
                              name="profilePictureUrlInput"
                              type="url"
                              defaultValue={profilePictureUrl}
                              onChange={(e) => setProfilePictureUrl(e.target.value)}
                              placeholder="https://placehold.co/150x150/cccccc/ffffff?text=PFP"
                              className={`w-full mt-4 p-3 border ${currentTheme.inputBorder} rounded-lg focus:ring-2 ${currentTheme.inputFocus} outline-none ${currentTheme.inputBg} ${currentTheme.inputTextColor}`}
                            />
                            <button
                                type="button"
                                onClick={() => openInfoModal(
                                    'what is a url?',
                                    'a URL is a link to an image, put simply. to get this link, find any image of your choice and right click it. select "copy image adress", and then paste the following link in the input box. (if the image is not publicly availible, it will most likely fail.)',
                                    'https://cdn.prod.website-files.com/62d84e447b4f9e7263d31e94/655f6a3627d3fcad6f5c8e60_copy-image-address.jpg'
                                )}
                                className={`absolute top-1/2 right-3 -translate-y-1/2 text-stone-500 hover:text-stone-700 transition-colors duration-200`}
                            >
                                <i className="fas fa-info-circle text-lg"></i>
                            </button>
                        </div>
                      </div>
                      <div className="w-full max-w-sm">
                        <label htmlFor="bioInput" className={`block text-center text-sm font-medium ${currentTheme.textColor} mb-2 lowercase`}>your bio:</label>
                        <textarea
                          id="bioInput"
                          name="bioInput"
                          defaultValue={bio}
                          onChange={(e) => setBio(e.target.value)}
                          placeholder="tell us about yourself (max 160 characters)"
                          maxLength="160"
                          rows="4"
                          className={`w-full p-3 border ${currentTheme.inputBorder} rounded-lg focus:ring-2 ${currentTheme.inputFocus} outline-none ${currentTheme.inputBg} ${currentTheme.inputTextColor} resize-y`}
                        ></textarea>
                      </div>

                      {/* Profile Preview Section */}
                      <div
                          className={`mt-8 p-6 rounded-xl shadow-md w-full max-w-sm relative`}
                          style={{ background: `linear-gradient(to bottom right, ${profileBgFromColor}, ${profileBgToColor})` }}
                      >
                          <h3 className={`text-xl font-bold mb-4 lowercase`} style={{color: profileTextColorProfile || currentTheme.textColor}}>how others see you:</h3>
                          {/* Banner behind profile picture */}
                          <div
                              className="w-full h-20 rounded-t-lg absolute top-0 left-0"
                              style={{
                                  background: profileBannerType === 'color' && profileBanner ? profileBanner : (profileBannerType === 'image' && profileBanner ? `url(${profileBanner}) center/cover no-repeat` : 'transparent')
                              }}
                          ></div>
                          <div className="relative z-10 flex flex-col items-center pt-10"> {/* PFP and text positioned over banner */}
                              <div className="relative w-20 h-20 mb-3 overflow-visible"> {/* Container for PFP and decoration - Added overflow-visible */}
                                <img
                                    src={profilePictureUrl || 'https://placehold.co/80x80/cccccc/ffffff?text=PFP'}
                                    alt="Profile Preview"
                                    className="w-full h-full rounded-full mx-auto object-cover border-4 border-stone-300 shadow-lg relative z-10"
                                    onError={(e) => e.target.src='https://placehold.co/80x80/cccccc/ffffff?text=PFP'}
                                />
                                {profileDecorationUrl && (
                                    <img
                                        src={profileDecorationUrl}
                                        alt="Decoration Preview"
                                        style={{
                                            position: 'absolute',
                                            width: `${profileDecorationSize}%`,
                                            height: `${profileDecorationSize}%`,
                                            top: '50%', // Center vertically
                                            left: '50%', // Center horizontally
                                            transform: 'translate(-50%, -50%)', // Adjust for element's own size
                                            objectFit: 'contain',
                                            zIndex: 20,
                                            pointerEvents: 'none',
                                        }}
                                        onError={(e) => e.target.style.display='none'}
                                    />
                                )}
                              </div>
                              <p className={`text-lg font-semibold lowercase`} style={{color: profileTextColorProfile || currentTheme.textColor}}>{displayName || displayUsername}</p>
                              <p className={`text-sm lowercase`} style={{color: profileTextColorProfile || currentTheme.secondaryText}}>@{displayUsername}</p>
                              {bio && <p className={`text-sm mt-2 whitespace-pre-wrap`} style={{color: profileTextColorProfile || currentTheme.secondaryText}}>{bio}</p>}
                              {isAdmin && (
                                  <span className="inline-block px-2 py-0.5 bg-stone-800 text-white text-xs rounded-full font-bold uppercase mt-2">admin</span>
                              )}
                          </div>
                      </div>
                    </div>

                    {/* Right Column: Account Details and Profile Theme */}
                    <form onSubmit={handleUpdateProfile} className="flex-1 flex flex-col space-y-6 lg:pl-8 items-center"> {/* Added items-center for horizontal centering */}
                      <h2 className={`text-3xl font-bold ${currentTheme.textColor} lowercase text-center`}>account details</h2>
                      <div className="w-full max-w-sm">
                        <label htmlFor="displayNameInput" className={`block text-left text-sm font-medium ${currentTheme.textColor} mb-1 lowercase`}>display name:</label>
                        <input
                          id="displayNameInput"
                          name="displayNameInput"
                          type="text"
                          value={displayName} // This is the state for what's shown publicly
                          onChange={(e) => setDisplayName(e.target.value)}
                          placeholder="your public display name"
                          className={`w-full p-3 border ${currentTheme.inputBorder} rounded-lg focus:ring-2 ${currentTheme.inputFocus} outline-none ${currentTheme.inputBg} ${currentTheme.inputTextColor}`}
                        />
                      </div>
                      <div className="w-full max-w-sm">
                        <label htmlFor="displayUsernameInput" className={`block text-left text-sm font-medium ${currentTheme.textColor} mb-1 lowercase`}>public username:</label>
                        <input
                          id="displayUsernameInput"
                          name="displayUsernameInput"
                          type="text"
                          value={displayUsername}
                          onChange={(e) => setDisplayUsername(e.target.value)}
                          placeholder="your public username"
                          className={`w-full p-3 border ${currentTheme.inputBorder} rounded-lg focus:ring-2 ${currentTheme.inputFocus} outline-none ${currentTheme.inputBg} ${currentTheme.inputTextColor}`}
                          required
                        />
                      </div>
                      <div className="w-full max-w-sm">
                        <label htmlFor="emailInput" className={`block text-left text-sm font-medium ${currentTheme.textColor} mb-1 lowercase`}>your email:</label>
                        <input
                          id="emailInput"
                          name="emailInput"
                          type="email"
                          value={userEmail}
                          onChange={(e) => setUserEmail(e.target.value)}
                          placeholder="your email address"
                          className={`w-full p-3 border ${currentTheme.inputBorder} rounded-lg focus:ring-2 ${currentTheme.inputFocus} outline-none ${currentTheme.inputBg} ${currentTheme.inputTextColor}`}
                          required
                        />
                      </div>

                      {/* Profile Theme Settings - Now a collapsible section */}
                      <div className="w-full max-w-sm mt-8 pt-4 border-t border-stone-200">
                          <button
                              type="button"
                              onClick={() => setShowProfileThemeSettings(!showProfileThemeSettings)}
                              className={`w-full flex justify-between items-center px-4 py-3 rounded-lg font-bold ${currentTheme.textColor} hover:bg-stone-100 transition duration-200 lowercase`}
                          >
                              <span>profile theme</span>
                              <i className={`fas ${showProfileThemeSettings ? 'fa-chevron-up' : 'fa-chevron-down'}`}></i>
                          </button>
                          {showProfileThemeSettings && (
                              <div className="space-y-4 mt-4">
                                  {/* Profile Gradient Colors */}
                                  <div className="flex flex-col">
                                      <label className={`block text-left text-sm font-medium ${currentTheme.textColor} mb-1 lowercase`}>profile gradient:</label>
                                      <div className="flex space-x-2">
                                          <input
                                              type="color"
                                              value={profileBgFromColor}
                                              onChange={(e) => setProfileBgFromColor(e.target.value)}
                                              className="w-1/2 h-10 rounded-lg border-2 cursor-pointer"
                                              title="From Color"
                                          />
                                          <input
                                              type="color"
                                              value={profileBgToColor}
                                              onChange={(e) => setProfileBgToColor(e.target.value)}
                                              className="w-1/2 h-10 rounded-lg border-2 cursor-pointer"
                                              title="To Color"
                                          />
                                      </div>
                                  </div>
                                  <div>
                                      <label className={`block text-left text-sm font-medium ${currentTheme.textColor} mb-1 lowercase`}>profile picture banner:</label>
                                      <div className="flex space-x-2 mb-2">
                                          <button
                                              type="button"
                                              onClick={() => setProfileBannerType('color')}
                                              className={`px-3 py-1 rounded-full text-xs font-semibold ${profileBannerType === 'color' ? `${currentTheme.buttonPrimaryBg} ${currentTheme.buttonPrimaryText}` : `${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText}`} lowercase`}
                                          >
                                              color
                                          </button>
                                          <button
                                              type="button"
                                              onClick={() => setProfileBannerType('image')}
                                              className={`px-3 py-1 rounded-full text-xs font-semibold ${profileBannerType === 'image' ? `${currentTheme.buttonPrimaryBg} ${currentTheme.buttonPrimaryText}` : `${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText}`} lowercase`}
                                          >
                                              image url
                                          </button>
                                      </div>
                                      {profileBannerType === 'color' ? (
                                          <input
                                              type="color"
                                              value={profileBanner.startsWith('#') ? profileBanner : '#cccccc'}
                                              onChange={(e) => setProfileBanner(e.target.value)}
                                              className="w-full h-10 rounded-lg border-2 cursor-pointer"
                                              title="Pick Banner Color"
                                          />
                                      ) : (
                                        <div className="relative w-full"> {/* Wrapper for input and info icon */}
                                          <input
                                              type="url"
                                              value={profileBanner}
                                              onChange={(e) => setProfileBanner(e.target.value)}
                                              placeholder="https://placehold.co/200x50/cccccc/ffffff?text=Banner"
                                              className={`w-full p-3 border ${currentTheme.inputBorder} rounded-lg focus:ring-2 ${currentTheme.inputFocus} outline-none ${currentTheme.inputBg} ${currentTheme.inputTextColor}`}
                                          />
                                          <button
                                              type="button"
                                              onClick={() => openInfoModal(
                                                  'Profile Banner URL Information',
                                                  'Paste a direct URL for your banner image here. It will stretch to fit the banner area.',
                                                  'https://placehold.co/300x100/94a3b8/ffffff?text=Banner+Image+URL'
                                              )}
                                              className={`absolute top-1/2 right-3 -translate-y-1/2 text-stone-500 hover:text-stone-700 transition-colors duration-200`}
                                          >
                                              <i className="fas fa-info-circle text-lg"></i>
                                          </button>
                                        </div>
                                      )}
                                  </div>
                                  <div>
                                    <label className={`block text-left text-sm font-medium ${currentTheme.textColor} mb-1 lowercase`}>profile text color:</label>
                                    <input
                                      type="color"
                                      value={profileTextColorProfile.startsWith('#') ? profileTextColorProfile : '#000000'}
                                      onChange={(e) => setProfileTextColorProfile(e.target.value)}
                                      className="w-full h-10 rounded-lg border-2 cursor-pointer"
                                      title="Pick Text Color"
                                    />
                                  </div>
                              </div>
                          )}
                      </div>

                      <button
                        type="submit"
                        className={`w-full max-w-sm ${currentTheme.buttonPrimaryBg} ${currentTheme.buttonPrimaryText} p-3 rounded-lg font-semibold ${currentTheme.buttonPrimaryHover} transition duration-300 shadow-md lowercase`}
                      >
                        save changes
                      </button>
                      <button
                        type="button"
                        onClick={() => setShowProfileModal(false)}
                        className={`w-full max-w-sm ${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} p-3 rounded-lg font-semibold ${currentTheme.buttonTertiaryHover} transition duration-300 lowercase`}
                      >
                        cancel
                      </button>
                      <button
                        type="button"
                        onClick={handleLogout}
                        className={`w-full max-w-sm mt-4 bg-red-500 text-white p-3 rounded-lg font-semibold hover:bg-red-600 transition duration-300 shadow-md lowercase`}
                      >
                        log out
                      </button>
                    </form>
                  </div>
                </div>
              )}

              {/* user profile modal */}
              {showUserProfileModal && selectedUserProfileId && (
                <UserProfileModal
                    profileId={selectedUserProfileId}
                    currentUserId={userId}
                    appId={appId}
                    db={db}
                    currentTheme={currentTheme}
                    onClose={() => setShowUserProfileModal(false)}
                    onAddFriend={addFriend}
                    friendsList={friendsList}
                    onOpenDm={handleOpenDm}
                    setErrorMessage={setErrorMessage}
                    setSuccessMessage={setSuccessMessage}
                />
              )}

              {/* chat settings modal */}
              {showChatSettingsModal && (
                <div className={`fixed inset-0 z-50 flex flex-col items-center justify-center`}
                  style={{
                      ...(currentTheme.mainBgColorStyle ? { backgroundColor: currentTheme.mainBgColorStyle } : {}),
                      ...currentTheme.mainBgImageStyle
                  }}
                >
                  <div className={`${currentTheme.chatBg} p-8 rounded-xl shadow-2xl w-full h-full max-w-md text-center overflow-y-auto ${currentTheme.scrollbar}`} style={currentTheme.scrollbarVars}>
                    <h2 className={`text-3xl font-bold mb-6 ${currentTheme.textColor} lowercase`}>chat settings</h2>
                    <div className="space-y-4">
                      <p className={`${currentTheme.textColor} text-lg lowercase`}>choose a theme:</p>
                      <div className="flex justify-around flex-wrap gap-4">
                        {Object.keys(themes).map((themeName) => (
                          <button
                            key={themeName}
                            onClick={() => handleThemeChange(themeName)}
                            className={`p-4 rounded-lg shadow-md ${themes[themeName].mainBgClass} ${themes[themeName].textColor} border-2 ${currentThemeName === themeName ? 'border-blue-500' : 'border-transparent'} flex flex-col items-center justify-center transition duration-200`}
                          >
                            <span className="font-semibold text-lg lowercase">{themes[themeName].name}</span>
                            <div className="flex gap-1 mt-2">
                                <div className={`w-4 h-4 rounded-full ${themes[themeName].myBubbleBg}`}></div>
                                <div className={`w-4 h-4 rounded-full ${themes[themeName].otherBubbleBg}`}></div>
                            </div>
                          </button>
                        ))}
                        {/* Custom Theme Button */}
                        <button
                            onClick={() => handleThemeChange('custom')}
                            className={`p-4 rounded-lg shadow-md bg-gradient-to-br from-purple-500 to-pink-500 text-white border-2 ${currentThemeName === 'custom' ? 'border-blue-500' : 'border-transparent'} flex flex-col items-center justify-center transition duration-200`}
                        >
                            <span className="font-semibold text-lg lowercase">custom</span>
                            <div className="flex gap-1 mt-2">
                                <div className={`w-4 h-4 rounded-full bg-purple-300`}></div>
                                <div className={`w-4 h-4 rounded-full bg-pink-300`}></div>
                            </div>
                        </button>
                      </div>

                      {currentThemeName === 'custom' && (
                          <div className="mt-8 space-y-4">
                              <h3 className={`text-xl font-bold ${currentTheme.textColor} lowercase`}>customize your theme</h3>
                              <div>
                                  <label className={`block text-left text-sm font-medium ${currentTheme.textColor} mb-1 lowercase`}>chat ui main background color:</label>
                                  <input
                                      type="color"
                                      value={customUIBgColor}
                                      onChange={handleCustomUIBgColorChange}
                                      className="w-full h-10 rounded-lg border-2 cursor-pointer"
                                      title="Pick UI Main Background Color"
                                  />
                              </div>
                              {/* Secondary UI Background Color */}
                              <div>
                                  <label className={`block text-left text-sm font-medium ${currentTheme.textColor} mb-1 lowercase`}>chat ui secondary background color (for buttons, etc.):</label>
                                  <input
                                      type="color"
                                      value={customUISecondaryBgColor}
                                      onChange={handleCustomUISecondaryBgColorChange}
                                      className="w-full h-10 rounded-lg border-2 cursor-pointer"
                                      title="Pick UI Secondary Background Color"
                                  />
                              </div>
                              {/* Primary Text Color */}
                              <div>
                                  <label className={`block text-left text-sm font-medium ${currentTheme.textColor} mb-1 lowercase`}>chat ui primary text color:</label>
                                  <input
                                      type="color"
                                      value={customUITextColor}
                                      onChange={handleCustomUITextColorChange}
                                      className="w-full h-10 rounded-lg border-2 cursor-pointer"
                                      title="Pick UI Primary Text Color"
                                  />
                              </div>
                              {/* Secondary Text Color */}
                              <div>
                                  <label className={`block text-left text-sm font-medium ${currentTheme.textColor} mb-1 lowercase`}>chat ui secondary text color:</label>
                                  <input
                                      type="color"
                                      value={customUISecondaryTextColor}
                                      onChange={handleCustomUISecondaryTextColorChange}
                                      className="w-full h-10 rounded-lg border-2 cursor-pointer"
                                      title="Pick UI Secondary Text Color"
                                  />
                              </div>
                              <div>
                                  <label className={`block text-left text-sm font-medium ${currentTheme.textColor} mb-1 lowercase`}>main app background:</label>
                                  <div className="flex space-x-2 mb-2">
                                      <button
                                          type="button"
                                          onClick={() => handleCustomMainBgTypeChange('color')}
                                          className={`px-3 py-1 rounded-full text-xs font-semibold ${customMainBgType === 'color' ? `${currentTheme.buttonPrimaryBg} ${currentTheme.buttonPrimaryText}` : `${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText}`} lowercase`}
                                      >
                                          color
                                      </button>
                                      <button
                                          type="button"
                                          onClick={() => handleCustomMainBgTypeChange('image')}
                                          className={`px-3 py-1 rounded-full text-xs font-semibold ${customMainBgType === 'image' ? `${currentTheme.buttonPrimaryBg} ${currentTheme.buttonPrimaryText}` : `${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText}`} lowercase`}
                                      >
                                          image url
                                      </button>
                                  </div>
                                  {customMainBgType === 'color' ? (
                                      <input
                                          type="color"
                                          value={customMainBgValue}
                                          onChange={handleCustomMainBgValueChange}
                                          className="w-full h-10 rounded-lg border-2 cursor-pointer"
                                          title="Pick Main Background Color"
                                      />
                                  ) : (
                                    <div className="relative w-full"> {/* Wrapper for input and info icon */}
                                      <input
                                          type="url"
                                          value={customMainBgValue}
                                          onChange={handleCustomMainBgValueChange}
                                          placeholder="https://example.com/background.jpg"
                                          className={`w-full p-3 border ${currentTheme.inputBorder} rounded-lg focus:ring-2 ${currentTheme.inputFocus} outline-none ${currentTheme.inputBg} ${currentTheme.inputTextColor}`}
                                      />
                                      <button
                                          type="button"
                                          onClick={() => openInfoModal(
                                              'what is a URL?',
                                              'a URL is a link to an image, put simply. to get this link, find any image of your choice and right click it. select "copy image adress", and then paste the following link in the input box. (if the image is not publicly availible, it will most likely fail.)',
                                              'https://cdn.prod.website-files.com/62d84e447b4f9e7263d31e94/655f6a3627d3fcad6f5c8e60_copy-image-address.jpg'
                                          )}
                                          className={`absolute top-1/2 right-3 -translate-y-1/2 text-stone-500 hover:text-stone-700 transition-colors duration-200`}
                                      >
                                          <i className="fas fa-info-circle text-lg"></i>
                                      </button>
                                    </div>
                                  )}
                              </div>
                              <div className="mt-8">
                                  <label className={`block text-left text-sm font-medium ${currentTheme.textColor} mb-1 lowercase`}>accent color (for your bubbles/buttons):</label>
                                  <div className="flex justify-center mt-2">
                                      <input
                                          type="color"
                                          value={customThemeAccentColor}
                                          onChange={handleCustomThemeAccentColorChange}
                                          className="w-16 h-16 rounded-full border-2 border-blue-500 cursor-pointer"
                                          title="Pick Custom Accent Color"
                                      />
                                  </div>
                              </div>
                          </div>
                      )}

                      {/* Custom Theme Presets */}
                      <div className="mt-8 pt-4 border-t border-stone-200">
                        <h3 className={`text-xl font-bold mb-4 ${currentTheme.textColor} lowercase`}>presets</h3>
                        {['slot1', 'slot2', 'slot3'].map((slotKey) => (
                            <div key={slotKey} className="mb-4 p-4 border rounded-lg border-stone-300">
                                <label className={`block text-left text-sm font-medium ${currentTheme.textColor} mb-1 lowercase`}>preset {slotKey.replace('slot', '')} name:</label>
                                <input
                                    type="text"
                                    value={customThemePresets[slotKey].name}
                                    onChange={(e) => setCustomThemePresets(prev => ({
                                        ...prev,
                                        [slotKey]: { ...prev[slotKey], name: e.target.value }
                                    }))}
                                    placeholder={`Name for ${slotKey}`}
                                    className={`w-full p-2 border ${currentTheme.inputBorder} rounded-lg mb-2 outline-none ${currentTheme.inputBg} ${currentTheme.inputTextColor}`}
                                />
                                <div className="flex space-x-2">
                                    <button
                                        type="button"
                                        onClick={() => savePreset(slotKey, customThemePresets[slotKey].name)}
                                        className={`flex-1 ${currentTheme.buttonPrimaryBg} ${currentTheme.buttonPrimaryText} p-2 rounded-lg font-semibold ${currentTheme.buttonPrimaryHover} transition duration-300 lowercase`}
                                    >
                                        save
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => loadPreset(slotKey)}
                                        className={`flex-1 ${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} p-2 rounded-lg font-semibold ${currentTheme.buttonTertiaryHover} transition duration-300 lowercase`}
                                    >
                                        load
                                    </button>
                                </div>
                            </div>
                        ))}
                      </div>


                      {/* Moved: Bubble Color Selection */}
                      <div className="mt-8">
                        <label className={`block text-left text-sm font-medium ${currentTheme.textColor} mb-1 lowercase`}>your chat bubble color:</label>
                        <div className="flex flex-wrap gap-2 justify-center">
                          {bubbleColorOptions.map((option) => (
                            <button
                              key={option.id}
                              type="button"
                              onClick={() => handleBubbleColorSelect(option.bgClass)}
                              className={`w-10 h-10 rounded-full border-2 ${myBubbleBgColor === option.bgClass || (myBubbleBgColor.startsWith('#') && getContrastingTextColor(myBubbleBgColor) !== 'text-black' && option.id === 'custom') ? 'border-blue-500' : 'border-transparent'} ${option.bgClass} flex items-center justify-center transition-all duration-200 ease-in-out transform hover:scale-110`}
                              title={option.label}
                            >
                                {/* No text in color bubbles */}
                            </button>
                          ))}
                            {/* Custom Color Picker Button */}
                            <div className={`w-10 h-10 rounded-full border-2 ${myBubbleBgColor.startsWith('#') ? 'border-blue-500' : 'border-transparent'} flex items-center justify-center transition-all duration-200 ease-in-out transform hover:scale-110 relative`}>
                                <input
                                    type="color"
                                    value={myBubbleBgColor.startsWith('#') ? myBubbleBgColor : '#cccccc'} /* Show current custom color or a default */
                                    onChange={(e) => handleBubbleColorSelect(e.target.value)}
                                    className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                    title="Choose Custom Color"
                                />
                                <i className={`fas fa-eye-dropper text-lg`} style={{color: myBubbleBgColor.startsWith('#') ? getContrastingTextColor(myBubbleBgColor) : '#78716c'}}></i> {/* Eyedropper icon using hex directly */}
                            </div>
                        </div>
                      </div>

                      {/* Toggle for others' custom colors */}
                      <div className="mt-8 pt-4 border-t border-stone-200">
                          <label className="flex items-center justify-between cursor-pointer">
                              <span className={`${currentTheme.textColor} text-lg lowercase`}>see others' custom colors:</span>
                              <input
                                  type="checkbox"
                                  className="toggle toggle-lg"
                                  checked={showOthersBubbleColors}
                                  onChange={() => setShowOthersBubbleColors(!showOthersBubbleColors)}
                              />
                          </label>
                          <p className={`${currentTheme.secondaryText} text-xs italic mt-2 lowercase`}>
                              if off, all other users' chat bubbles will appear in your chosen bubble color.
                          </p>
                      </div>

                    </div>
                    <button
                      type="button"
                      onClick={() => setShowChatSettingsModal(false)}
                      className={`w-full mt-6 ${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} p-3 rounded-lg font-semibold ${currentTheme.buttonTertiaryHover} transition duration-300 lowercase`}
                    >
                      close
                    </button>
                  </div>
                </div>
              )}

              {/* Admin Panel Modal */}
              {showAdminPanelModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className={`${currentTheme.chatBg} p-8 rounded-xl shadow-2xl w-full max-w-md text-center`}>
                    <h2 className={`text-3xl font-bold mb-6 ${currentTheme.textColor} lowercase`}>admin panel</h2>
                    <div className="space-y-4">
                        <label className="flex items-center justify-between cursor-pointer">
                            <span className={`${currentTheme.textColor} text-lg lowercase`}>enable hover to delete:</span>
                            <input
                                type="checkbox"
                                className="toggle toggle-lg"
                                checked={hoverToDeleteEnabled}
                                onChange={handleToggleHoverToDelete}
                            />
                        </label>
                        {/* New Admin Tag Settings */}
                        <label className="flex items-center justify-between cursor-pointer mt-4">
                            <span className={`${currentTheme.textColor} text-lg lowercase`}>show admin tag:</span>
                            <input
                                type="checkbox"
                                className="toggle toggle-lg"
                                checked={showAdminTag}
                                onChange={handleToggleShowAdminTag}
                            />
                        </label>
                        <div className="mt-4">
                            <label className={`block text-left text-sm font-medium ${currentTheme.textColor} mb-1 lowercase`}>admin tag text:</label>
                            <input
                                type="text"
                                value={adminTagText}
                                onChange={handleAdminTagTextChange}
                                placeholder="e.g., moderator"
                                className={`w-full p-3 border ${currentTheme.inputBorder} rounded-lg focus:ring-2 ${currentTheme.inputFocus} outline-none ${currentTheme.inputBg} ${currentTheme.inputTextColor} lowercase`}
                                maxLength="10"
                            />
                        </div>
                        <div className="mt-4">
                            <label className={`block text-left text-sm font-medium ${currentTheme.textColor} mb-1 lowercase`}>admin tag color:</label>
                            <input
                                type="color"
                                value={adminTagColor}
                                onChange={handleAdminTagColorChange}
                                className="w-full h-10 rounded-lg border-2 cursor-pointer"
                                title="Pick Admin Tag Color"
                            />
                        </div>
                        {/* Admin Tag Live Preview */}
                        <div className="mt-4 flex items-center justify-center">
                            <span
                                className="px-3 py-1 rounded-full font-bold uppercase text-sm"
                                style={{ backgroundColor: adminTagColor, color: getContrastingTextColor(adminTagColor) }}
                            >
                                {adminTagText} preview
                            </span>
                        </div>

                        {/* NEW: Profile Decorations Section - Now uses URL input and size slider */}
                        <div className="mt-8 pt-4 border-t border-stone-200">
                            <h3 className={`text-xl font-bold mb-4 ${currentTheme.textColor} lowercase`}>profile decorations</h3>
                            <div className="flex flex-col items-center space-y-4">
                                {tempProfileDecorationUrl && (
                                    <div className="relative w-24 h-24 rounded-full overflow-visible border-2 border-stone-300"> {/* Changed overflow-hidden to overflow-visible */}
                                        <img src={profilePictureUrl || 'https://placehold.co/80x80/cccccc/ffffff?text=PFP'} alt="Base PFP" className="w-full h-full object-cover" />
                                        <img
                                            src={tempProfileDecorationUrl}
                                            alt="Current Decoration"
                                            style={{
                                                position: 'absolute',
                                                width: `${tempProfileDecorationSize}%`,
                                                height: `${tempProfileDecorationSize}%`,
                                                top: '50%', // Center vertically
                                                left: '50%', // Center horizontally
                                                transform: 'translate(-50%, -50%)', // Adjust for element's own size
                                                objectFit: 'contain',
                                                zIndex: 20,
                                                pointerEvents: 'none',
                                            }}
                                            onError={(e) => e.target.style.display='none'}
                                        />
                                    </div>
                                )}
                                <div className="relative w-full"> {/* Wrapper for input and info icon */}
                                    <input
                                        type="url"
                                        value={tempProfileDecorationUrl}
                                        onChange={(e) => setTempProfileDecorationUrl(e.target.value)}
                                        placeholder="https://example.com/decoration.png (transparent png/gif)"
                                        className={`w-full p-3 border ${currentTheme.inputBorder} rounded-lg focus:ring-2 ${currentTheme.inputFocus} outline-none ${currentTheme.inputBg} ${currentTheme.inputTextColor} lowercase`}
                                    />
                                    <button
                                        type="button"
                                        onClick={() => openInfoModal(
                                            'Profile Decoration URL Information',
                                            'Upload a transparent PNG or GIF image to use as your profile decoration. This image will appear over your profile picture.',
                                            'https://placehold.co/300x200/ef4444/ffffff?text=Decoration+URL+Example'
                                        )}
                                        className={`absolute top-1/2 right-3 -translate-y-1/2 text-stone-500 hover:text-stone-700 transition-colors duration-200`}
                                    >
                                        <i className="fas fa-info-circle text-lg"></i>
                                    </button>
                                </div>
                                {/* Decoration Size Slider */}
                                <div className="w-full max-w-sm">
                                    <label htmlFor="decorationSize" className={`block text-left text-sm font-medium ${currentTheme.textColor} mb-1 lowercase`}>decoration size (%): <span className="font-semibold">{tempProfileDecorationSize}</span></label>
                                    <input
                                        id="decorationSize"
                                        type="range"
                                        min="50"
                                        max="200"
                                        step="5"
                                        value={tempProfileDecorationSize}
                                        onChange={(e) => setTempProfileDecorationSize(parseInt(e.target.value))}
                                        className="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer range-lg dark:bg-stone-700"
                                    />
                                </div>
                                <div className="flex space-x-2 w-full">
                                    <button
                                        onClick={() => {
                                            setTempProfileDecorationUrl(''); // Clear the URL locally
                                            setTempProfileDecorationSize(100); // Reset size locally
                                            // Debounce effect will handle saving to Firestore after this change
                                        }}
                                        className={`flex-1 bg-red-500 text-white p-3 rounded-lg font-semibold hover:bg-red-600 transition duration-300 shadow-md lowercase`}
                                    >
                                        clear decoration
                                    </button>
                                </div>
                                <p className={`${currentTheme.secondaryText} text-xs italic lowercase`}>
                                    paste a direct link to a transparent .png or .gif image. changes save automatically.
                                </p>
                            </div>
                        </div>

                        {/* NEW: Global Announcement Section */}
                        <div className="mt-8 pt-4 border-t border-stone-200">
                            <h3 className={`text-xl font-bold mb-4 ${currentTheme.textColor} lowercase`}>global announcement</h3>
                            <textarea
                                placeholder="type your announcement here (max 200 characters)"
                                maxLength="200"
                                rows="3"
                                className={`w-full p-3 border ${currentTheme.inputBorder} rounded-lg focus:ring-2 ${currentTheme.inputFocus} outline-none ${currentTheme.inputBg} ${currentTheme.inputTextColor} resize-y mb-4`}
                                onKeyDown={(e) => { // Added onKeyDown to prevent Enter from submitting form
                                    if (e.key === 'Enter' && !e.shiftKey) {
                                        e.preventDefault();
                                        handleSendGlobalAnnouncement(e.target.value);
                                        e.target.value = ''; // Clear after sending
                                    }
                                }}
                                id="globalAnnouncementInput" // Added ID for easier access
                            ></textarea>
                            <button
                                onClick={() => {
                                    const textarea = document.getElementById('globalAnnouncementInput');
                                    handleSendGlobalAnnouncement(textarea.value);
                                    textarea.value = '';
                                }}
                                className={`w-full ${currentTheme.buttonPrimaryBg} ${currentTheme.buttonPrimaryText} p-3 rounded-lg font-semibold ${currentTheme.buttonPrimaryHover} transition duration-300 shadow-md lowercase`}
                            >
                                send announcement
                            </button>
                            <p className={`${currentTheme.secondaryText} text-xs italic mt-2 lowercase`}>
                                hit enter or click to send. shift+enter for new line.
                            </p>
                        </div>

                        <button
                            onClick={() => { setShowAdminPanelModal(false); setShowBanMenuModal(true); }}
                            className={`w-full ${currentTheme.buttonSecondaryBg} ${currentTheme.buttonSecondaryText} p-3 rounded-lg font-semibold ${currentTheme.buttonSecondaryHover} transition duration-300 shadow-md lowercase`}
                        >
                            ban menu
                        </button>
                    </div>
                    <button
                      onClick={() => setShowAdminPanelModal(false)}
                      className={`w-full mt-6 ${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} p-3 rounded-lg font-semibold ${currentTheme.buttonTertiaryHover} transition duration-300 shadow-md lowercase`}
                    >
                      close admin panel
                    </button>
                  </div>
                </div>
              )}

              {/* Active Users Modal */}
              {showActiveUsersModal && (
                  <ActiveUsersModal
                      activeRoomCode={activeRoomCode}
                      currentTheme={currentTheme}
                      onClose={() => setShowActiveUsersModal(false)}
                      db={db}
                      appId={appId}
                      currentUserId={userId}
                      onOpenUserProfile={handleOpenUserProfile}
                      isAdmin={isAdmin} // Pass isAdmin prop
                      promptKickUser={promptKickUser} // Pass kick function
                      promptBanUser={promptBanUser} // Pass ban function
                  />
              )}

              {/* Confirmation Modal for Clear All */}
              {showConfirmClearModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className={`${currentTheme.chatBg} p-8 rounded-xl shadow-2xl w-full max-w-sm text-center`}>
                    <h2 className={`text-2xl font-bold mb-6 ${currentTheme.textColor} lowercase`}>clear all messages?</h2>
                    <p className={`${currentTheme.textColor} mb-8`}>are you sure you want to clear ALL chat messages?</p>
                    <div className="flex justify-center space-x-4">
                      <button
                        onClick={confirmClearAllMessages}
                        className={`bg-red-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-700 transition duration-300 shadow-md lowercase`}
                      >
                        yes, clear all
                      </button>
                      <button
                        onClick={cancelClearAllMessages}
                        className={`${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} px-6 py-3 rounded-lg font-semibold ${currentTheme.buttonTertiaryHover} transition duration-300 lowercase`}
                      >
                        cancel
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Confirmation Modal for Kick */}
              {showConfirmKickModal && userToKick && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className={`${currentTheme.chatBg} p-8 rounded-xl shadow-2xl w-full max-w-sm text-center`}>
                    <h2 className={`text-2xl font-bold mb-6 ${currentTheme.textColor} lowercase`}>kick user?</h2>
                    <p className={`${currentTheme.textColor} mb-8`}>are you sure you want to kick <span className="font-semibold">{userToKick.displayName || userToKick.displayUsername}</span> from this room?</p>
                    <div className="flex justify-center space-x-4">
                      <button
                        onClick={performKickUser}
                        className={`bg-red-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-700 transition duration-300 shadow-md lowercase`}
                      >
                        yes, kick
                      </button>
                      <button
                        onClick={cancelKickBan}
                        className={`${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} px-6 py-3 rounded-lg font-semibold ${currentTheme.buttonTertiaryHover} transition duration-300 lowercase`}
                      >
                        cancel
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Confirmation Modal for Ban */}
              {showConfirmBanModal && userToBan && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className={`${currentTheme.chatBg} p-8 rounded-xl shadow-2xl w-full max-w-sm text-center`}>
                    <h2 className={`text-2xl font-bold mb-6 ${currentTheme.textColor} lowercase`}>ban user?</h2>
                    <p className={`${currentTheme.textColor} mb-8`}>are you sure you want to ban <span className="font-semibold">{userToBan.displayName || userToBan.displayUsername}</span> globally for 10 minutes?</p>
                    <div className="flex justify-center space-x-4">
                      <button
                        onClick={performBanUser}
                        className={`bg-red-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-700 transition duration-300 shadow-md lowercase`}
                      >
                        yes, ban
                      </button>
                      <button
                        onClick={cancelKickBan}
                        className={`${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} px-6 py-3 rounded-lg font-semibold ${currentTheme.buttonTertiaryHover} transition duration-300 lowercase`}
                      >
                        cancel
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Ban Menu Modal */}
              {showBanMenuModal && (
                <BanMenuModal
                  currentTheme={currentTheme}
                  onClose={() => setShowBanMenuModal(false)}
                  db={db}
                  appId={appId}
                  currentUserId={userId}
                  onOpenUserProfile={handleOpenUserProfile}
                  isAdmin={isAdmin}
                  promptRevertBan={promptRevertBan}
                />
              )}

              {/* Confirmation Modal for Revert Ban */}
              {showConfirmRevertBanModal && userToRevertBan && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className={`${currentTheme.chatBg} p-8 rounded-xl shadow-2xl w-full max-w-sm text-center`}>
                    <h2 className={`text-2xl font-bold mb-6 ${currentTheme.textColor} lowercase`}>revert ban?</h2>
                    <p className={`${currentTheme.textColor} mb-8`}>are you sure you want to revert the ban for <span className="font-semibold">{userToRevertBan.displayName || userToRevertBan.displayUsername}</span>?</p>
                    <div className="flex justify-center space-x-4">
                      <button
                        onClick={performRevertBan}
                        className={`bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-300 shadow-md lowercase`}
                      >
                        yes, revert
                      </button>
                      <button
                        onClick={cancelRevertBan}
                        className={`${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} px-6 py-3 rounded-lg font-semibold ${currentTheme.buttonTertiaryHover} transition duration-300 lowercase`}
                      >
                        cancel
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* NEW: InfoIconModal */}
              {showInfoModal && (
                  <InfoIconModal
                      title={infoModalContent.title}
                      message={infoModalContent.message}
                      imageUrl={infoModalContent.imageUrl}
                      currentTheme={currentTheme}
                      onClose={() => setShowInfoModal(false)}
                  />
              )}

              {/* NEW: Changelog Button */}
              <button
                  onClick={() => setShowChangelogModal(true)}
                  className={`fixed bottom-4 left-4 ${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} px-4 py-2 rounded-lg text-sm font-semibold ${currentTheme.buttonTertiaryHover} transition duration-300 shadow-md lowercase`}
                  title="View Changelog"
              >
                  changelog
              </button>

              {/* NEW: Changelog Modal */}
              {showChangelogModal && (
                  <ChangelogModal
                      currentTheme={currentTheme}
                      onClose={() => setShowChangelogModal(false)}
                  />
              )}

              {/* "made by" text at the bottom */}
              <p className={`mt-8 ${currentTheme.secondaryText} text-xs lowercase`}>made by oliver</p>
            </div>
          );
        };

        // UserProfileModal Component
        const UserProfileModal = ({ profileId, currentUserId, appId, db, currentTheme, onClose, onAddFriend, friendsList, onOpenDm, setErrorMessage, setSuccessMessage }) => {
            const [profileData, setProfileData] = React.useState(null);
            const [isLoading, setIsLoading] = React.useState(true);
            const [isFriend, setIsFriend] = React.useState(false);
            const [dmRoomCode, setDmRoomCode] = React.useState(null);

            React.useEffect(() => {
                const fetchProfile = async () => {
                    setIsLoading(true);
                    setProfileData(null);
                    setIsFriend(false);
                    setDmRoomCode(null); // Reset DM room code

                    if (!profileId || !currentUserId) {
                        setIsLoading(false);
                        return;
                    }

                    if (profileId === currentUserId) {
                        setSuccessMessage('you are viewing your own profile.');
                        setIsLoading(false);
                        // Fetch own profile data for display
                        const ownProfileRef = doc(db, `artifacts/${appId}/users/${currentUserId}/userProfiles`, currentUserId);
                        try {
                            const ownProfileSnap = await getDoc(ownProfileRef);
                            if (ownProfileSnap.exists()) {
                                setProfileData(ownProfileSnap.data());
                            }
                        } catch (error) {
                            console.error("Error fetching own profile in modal:", error);
                        }
                        return;
                    }

                    // Check if already friends and get DM room code
                    const friendDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/friends`, profileId);
                    try {
                        const friendDocSnap = await getDoc(friendDocRef);
                        if (friendDocSnap.exists()) {
                            setIsFriend(true);
                            setDmRoomCode(friendDocSnap.data().dmRoomCode);
                        } else {
                            // If not found in friend's collection, generate it now as a fallback
                            setDmRoomCode(generateDmRoomCode(currentUserId, profileId));
                        }
                    } catch (error) {
                        console.error("Error checking friendship status or generating DM code:", error);
                        setDmRoomCode(generateDmRoomCode(currentUserId, profileId)); // Fallback in case of error
                    }

                    // Fetch the other user's profile data
                    const userProfileRef = doc(db, `artifacts/${appId}/users/${profileId}/userProfiles`, profileId);
                    try {
                        const docSnap = await getDoc(userProfileRef);
                        if (docSnap.exists()) {
                            setProfileData(docSnap.data());
                        } else {
                            setErrorMessage('user profile not found.');
                        }
                    } catch (error) {
                        setErrorMessage('failed to load user profile.');
                        console.error("Error fetching user profile:", error);
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchProfile();
            }, [profileId, currentUserId, db, appId, friendsList]); // Re-fetch if friendsList changes

            const handleAddFriendClick = () => {
                if (profileData) {
                    onAddFriend(profileData.id || profileId, profileData.displayName || profileData.displayUsername);
                }
            };

            const handleOpenDmClick = () => {
                if (dmRoomCode) {
                    console.log("UserProfileModal: Calling onOpenDm with profileId:", profileId, "dmRoomCode:", dmRoomCode);
                    onOpenDm(profileId, dmRoomCode);
                    onClose(); // Close the profile modal after opening DM
                } else {
                    console.error("UserProfileModal: No dmRoomCode available to open DM for profileId:", profileId);
                    setErrorMessage("Could not open DM: DM room code missing.");
                }
            };

            const profileBannerStyle = React.useMemo(() => {
                if (profileData?.profileBannerType === 'color' && profileData.profileBanner) {
                    return { backgroundColor: profileData.profileBanner };
                } else if (profileData?.profileBannerType === 'image' && profileData.profileBanner) {
                    return { backgroundImage: `url(${profileData.profileBanner})`, backgroundSize: 'cover', backgroundPosition: 'center', backgroundRepeat: 'no-repeat' };
                }
                return {};
            }, [profileData?.profileBanner, profileData?.profileBannerType]);

            // Calculate dynamic decoration style for other users' profiles
            const decorationSize = profileData?.profileDecorationSize || 100; // Default to 100%
            const decorationStyle = {
                position: 'absolute',
                width: `${decorationSize}%`,
                height: `${decorationSize}%`,
                top: '50%', // Center vertically
                left: '50%', // Center horizontally
                transform: 'translate(-50%, -50%)', // Adjust for element's own size
                objectFit: 'contain',
                zIndex: 20,
                pointerEvents: 'none',
            };


            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className={`${currentTheme.chatBg} p-8 rounded-xl shadow-2xl w-full max-w-md text-center ${currentTheme.scrollbar}`} style={currentTheme.scrollbarVars}>
                        <h2 className={`text-3xl font-bold mb-6 ${currentTheme.textColor} lowercase`}>user profile</h2>
                        {isLoading ? (
                            <p className={`${currentTheme.secondaryText}`}>loading profile...</p>
                        ) : profileData ? (
                            <div className="space-y-4">
                                {/* Themed Profile Card */}
                                <div
                                    className={`relative rounded-xl overflow-hidden shadow-lg p-6 pt-16`} /* Add pt-16 for space below banner */
                                    style={{ background: `linear-gradient(to bottom right, ${profileData.profileBgFromColor || '#ffffff'}, ${profileData.profileBgToColor || '#e0e0e0'})` }}
                                >
                                    {/* Profile Banner */}
                                    <div
                                        className="absolute top-0 left-0 w-full h-24" // Adjust height for banner
                                        style={profileBannerStyle}
                                    ></div>

                                    {/* Profile Picture (positioned over banner) */}
                                    <div className="relative w-24 h-24 mx-auto mb-3 overflow-visible"> {/* Container for PFP and decoration - Added overflow-visible */}
                                        <img
                                            src={profileData.profilePictureUrl || 'https://placehold.co/100x100/cccccc/ffffff?text=PFP'}
                                            alt="Profile Picture"
                                            className="w-full h-full rounded-full object-cover border-4 border-white shadow-md relative z-10"
                                            onError={(e) => e.target.src='https://placehold.co/100x100/cccccc/ffffff?text=PFP'}
                                        />
                                        {profileData.profileDecorationUrl && (
                                            <img
                                                src={profileData.profileDecorationUrl}
                                                alt="Decoration"
                                                style={decorationStyle}
                                                onError={(e) => e.target.style.display='none'}
                                            />
                                        )}
                                    </div>

                                    {/* Profile Details */}
                                    <p className={`text-2xl font-bold lowercase mt-4`} style={{color: profileData.profileTextColorProfile || currentTheme.textColor}}>
                                        {profileData.displayName || profileData.displayUsername || 'anonymous'}
                                    </p>
                                    <p className={`text-sm lowercase`} style={{color: profileData.profileTextColorProfile || currentTheme.secondaryText}}>username: {profileData.displayUsername}</p>
                                    
                                    {(profileData.bio !== undefined && profileData.bio !== null) ? (
                                        <div className={`text-left mt-4 p-3 rounded-lg bg-black/10`}> {/* bg-black/10 for subtle contrast on themed background */}
                                            <p className={`text-sm font-medium lowercase mb-1`} style={{color: profileData.profileTextColorProfile || currentTheme.textColor}}>bio:</p>
                                            {profileData.bio.length > 0 ? (
                                                <p className={`text-sm whitespace-pre-wrap`} style={{color: profileData.profileTextColorProfile || currentTheme.secondaryText}}>{profileData.bio}</p>
                                            ) : (
                                                <p className={`text-sm whitespace-pre-wrap italic opacity-80`} style={{color: profileData.profileTextColorProfile || currentTheme.secondaryText}}>bio not set.</p>
                                            )}
                                        </div>
                                    ) : (
                                        <p className={`text-sm lowercase`} style={{color: profileData.profileTextColorProfile || currentTheme.secondaryText}}>no bio available.</p>
                                    )}
                                    {profileData.isAdmin && (
                                        <span className="inline-block px-3 py-1 bg-stone-800 text-white text-xs rounded-full font-bold uppercase mt-2">admin</span>
                                    )}
                                </div>

                                {/* Action buttons */}
                                {profileId !== currentUserId && (
                                    <div className="flex flex-col space-y-3 mt-6">
                                        {isFriend ? (
                                            <button
                                                onClick={handleOpenDmClick}
                                                className={`w-full ${currentTheme.buttonPrimaryBg} ${currentTheme.buttonPrimaryText} p-3 rounded-lg font-semibold ${currentTheme.buttonPrimaryHover} transition duration-300 shadow-md lowercase`}
                                            >
                                                send direct message
                                            </button>
                                        ) : (
                                            <button
                                                onClick={handleAddFriendClick}
                                                className={`w-full ${currentTheme.buttonSecondaryBg} ${currentTheme.buttonSecondaryText} p-3 rounded-lg font-semibold ${currentTheme.buttonSecondaryHover} transition duration-300 shadow-md lowercase`}
                                            >
                                                add friend
                                            </button>
                                        )}
                                    </div>
                                )}
                            </div>
                        ) : (
                            <p className={`${currentTheme.secondaryText}`}>no profile data found.</p>
                        )}
                        <button
                            onClick={onClose}
                            className={`w-full mt-6 ${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} p-3 rounded-lg font-semibold ${currentTheme.buttonTertiaryHover} transition duration-300 lowercase`}
                        >
                            close
                        </button>
                    </div>
                </div>
            );
        };

        // ActiveUsersModal Component
        const ActiveUsersModal = ({ activeRoomCode, currentTheme, onClose, db, appId, currentUserId, onOpenUserProfile, isAdmin, promptKickUser, promptBanUser }) => {
            const [activeUsersList, setActiveUsersList] = React.useState([]);
            const [recentlyActiveUsersList, setRecentlyActiveUsersList] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(true);
            const activeThreshold = 5 * 60 * 1000; // 5 minutes in milliseconds

            React.useEffect(() => {
                if (!activeRoomCode) {
                    setIsLoading(false);
                    return;
                }

                const activityCollectionRef = collection(db, `artifacts/${appId}/public/data/chatroomActivity/${activeRoomCode}/users`);

                const unsubscribe = onSnapshot(activityCollectionRef, async (snapshot) => {
                    setIsLoading(true);
                    const fetchedActivityData = [];
                    const now = Date.now();

                    for (const docSnap of snapshot.docs) {
                        const activity = docSnap.data();
                        const userId = docSnap.id;
                        const lastActivityTime = activity.lastActivity?.toDate().getTime();

                        // Fetch user profile for display details
                        const userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/userProfiles`, userId);
                        try {
                            const profileSnap = await getDoc(userProfileRef);
                            if (profileSnap.exists()) {
                                fetchedActivityData.push({
                                    id: userId,
                                    ...profileSnap.data(),
                                    lastActivity: lastActivityTime,
                                });
                            }
                        } catch (error) {
                            console.error(`Error fetching profile for active user ${userId}:`, error);
                            // Fallback to minimal data if profile fetch fails
                            fetchedActivityData.push({
                                id: userId,
                                displayUsername: userId, // Fallback
                                displayName: userId, // Fallback
                                profilePictureUrl: '',
                                profileDecorationUrl: '', // Default empty decoration
                                profileDecorationSize: 100, // Default size
                                lastActivity: lastActivityTime,
                            });
                        }
                    }

                    const active = [];
                    const recentlyActive = [];

                    fetchedActivityData.forEach(user => {
                        if (user.id === currentUserId) { // Always show self as active if present
                            active.push({ ...user, status: 'active' });
                        } else if (now - user.lastActivity < activeThreshold) {
                            active.push({ ...user, status: 'active' });
                        } else {
                            recentlyActive.push({ ...user, status: 'inactive' });
                        }
                    });

                    // Sort alphabetically by display name
                    active.sort((a, b) => (a.displayName || a.displayUsername).localeCompare(b.displayName || b.displayUsername));
                    recentlyActive.sort((a, b) => (a.displayName || a.displayUsername).localeCompare(b.displayName || b.displayUsername));

                    setActiveUsersList(active);
                    setRecentlyActiveUsersList(recentlyActive);
                    setIsLoading(false);
                }, (error) => {
                    console.error("Error fetching chatroom activity:", error);
                    setIsLoading(false);
                });

                return () => unsubscribe();
            }, [activeRoomCode, db, appId, currentUserId]);

            // Define dynamic decoration style for users in this modal
            const getDecorationStyle = (size) => ({
                position: 'absolute',
                width: `${size || 100}%`,
                height: `${size || 100}%`,
                top: '50%', // Center vertically
                left: '50%', // Center horizontally
                transform: 'translate(-50%, -50%)', // Adjust for element's own size
                objectFit: 'contain',
                zIndex: 20,
                pointerEvents: 'none',
            });

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className={`${currentTheme.chatBg} p-8 rounded-xl shadow-2xl w-full max-w-md h-[70vh] flex flex-col text-center`}>
                        <h2 className={`text-3xl font-bold mb-6 ${currentTheme.textColor} lowercase`}>users in {activeRoomCode}</h2>
                        {isLoading ? (
                            <p className={`${currentTheme.secondaryText}`}>loading users...</p>
                        ) : (
                            <div className={`flex-1 overflow-y-auto ${currentTheme.scrollbar}`} style={currentTheme.scrollbarVars}>
                                {activeUsersList.length > 0 && (
                                    <div>
                                        <h3 className={`text-xl font-bold mb-3 ${currentTheme.textColor} lowercase border-b pb-2 ${currentTheme.inputBorder}`}>active now</h3>
                                        <div className="space-y-3">
                                            {activeUsersList.map(user => (
                                                <div key={user.id} className={`flex items-center p-3 rounded-lg shadow-sm lowercase ${currentTheme.otherBubbleBg}`}> {/* Updated this background */}
                                                    <div className="relative w-8 h-8 flex-shrink-0 mr-3 overflow-visible"> {/* Container for PFP and decoration - Added overflow-visible */}
                                                        <img
                                                            src={user.profilePictureUrl || 'https://placehold.co/32x32/cccccc/ffffff?text=P'}
                                                            alt="PFP"
                                                            className="w-full h-full rounded-full object-cover relative z-10"
                                                        />
                                                        {user.profileDecorationUrl && (
                                                            <img
                                                                src={user.profileDecorationUrl}
                                                                alt="Decoration"
                                                                style={getDecorationStyle(user.profileDecorationSize)}
                                                                onError={(e) => e.target.style.display='none'}
                                                            />
                                                        )}
                                                    </div>
                                                    <span
                                                        className={`font-semibold cursor-pointer hover:underline ${currentTheme.textColor}`}
                                                        onClick={() => onOpenUserProfile(user.id)}
                                                    >
                                                        {user.displayName || user.displayUsername}
                                                    </span>
                                                    {user.id === currentUserId && <span className={`ml-2 text-xs px-2 py-1 rounded-full bg-blue-500 text-white`}> (you)</span>}
                                                    {user.isAdmin && <span className={`ml-2 text-xs px-2 py-1 rounded-full bg-stone-800 text-white`}> admin</span>}
                                                    {isAdmin && user.id !== currentUserId && ( // Admin controls
                                                        <div className="ml-auto flex space-x-2">
                                                            <button
                                                                onClick={() => promptKickUser(user)}
                                                                className="bg-red-500 text-white px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-600 transition duration-200 lowercase"
                                                                title="Kick from room"
                                                            >
                                                                kick
                                                            </button>
                                                            <button
                                                                onClick={() => promptBanUser(user)}
                                                                className="bg-purple-500 text-white px-3 py-1 rounded-full text-xs font-semibold hover:bg-purple-600 transition duration-200 lowercase"
                                                                title="Ban globally for 10 min"
                                                            >
                                                                ban
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {recentlyActiveUsersList.length > 0 && (
                                    <div className="mt-8">
                                        <h3 className={`text-xl font-bold mb-3 ${currentTheme.textColor} lowercase border-b pb-2 ${currentTheme.inputBorder}`}>recently active</h3>
                                        <div className="space-y-3">
                                            {recentlyActiveUsersList.map(user => (
                                                <div key={user.id} className={`flex items-center p-3 rounded-lg shadow-sm lowercase opacity-70 ${currentTheme.chatBg}`}> {/* Updated this background */}
                                                    <div className="relative w-8 h-8 flex-shrink-0 mr-3 overflow-visible"> {/* Container for PFP and decoration - Added overflow-visible */}
                                                        <img
                                                            src={user.profilePictureUrl || 'https://placehold.co/32x32/cccccc/ffffff?text=P'}
                                                            alt="PFP"
                                                            className="w-full h-full rounded-full object-cover relative z-10"
                                                        />
                                                        {user.profileDecorationUrl && (
                                                            <img
                                                                src={user.profileDecorationUrl}
                                                                alt="Decoration"
                                                                style={getDecorationStyle(user.profileDecorationSize)}
                                                                onError={(e) => e.target.style.display='none'}
                                                            />
                                                        )}
                                                    </div>
                                                    <span
                                                        className={`font-semibold cursor-pointer hover:underline ${currentTheme.secondaryText}`}
                                                        onClick={() => onOpenUserProfile(user.id)}
                                                    >
                                                        {user.displayName || user.displayUsername}
                                                    </span>
                                                    <span className={`ml-2 text-xs px-2 py-1 rounded-full bg-gray-400 text-white`}>inactive</span>
                                                    {user.isAdmin && <span className={`ml-2 text-xs px-2 py-1 rounded-full bg-stone-600 text-white`}> admin</span>}
                                                    {isAdmin && user.id !== currentUserId && ( // Admin controls
                                                        <div className="ml-auto flex space-x-2">
                                                            <button
                                                                onClick={() => promptKickUser(user)}
                                                                className="bg-red-500 text-white px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-600 transition duration-200 lowercase"
                                                                title="Kick from room"
                                                            >
                                                                kick
                                                            </button>
                                                            <button
                                                                onClick={() => promptBanUser(user)}
                                                                className="bg-purple-500 text-white px-3 py-1 rounded-full text-xs font-semibold hover:bg-purple-600 transition duration-200 lowercase"
                                                                title="Ban globally for 10 min"
                                                            >
                                                                ban
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                {activeUsersList.length === 0 && recentlyActiveUsersList.length === 0 && (
                                    <p className={`${currentTheme.secondaryText} mt-8`}>no users found in this chatroom.</p>
                                )}
                            </div>
                        )}
                        <button
                            onClick={onClose}
                            className={`w-full mt-6 ${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} p-3 rounded-lg font-semibold ${currentTheme.buttonTertiaryHover} transition duration-300 lowercase`}
                        >
                            close
                        </button>
                    </div>
                </div>
            );
        };

        // New BanMenuModal Component
        const BanMenuModal = ({ currentTheme, onClose, db, appId, currentUserId, onOpenUserProfile, isAdmin, promptRevertBan }) => {
            const [bannedUsers, setBannedUsers] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(true);

            React.useEffect(() => {
                if (!isAdmin) {
                    setIsLoading(false);
                    return;
                }

                const bannedUsersCollectionRef = collection(db, `artifacts/${appId}/public/data/bannedUsers`);

                const unsubscribe = onSnapshot(bannedUsersCollectionRef, async (snapshot) => {
                    setIsLoading(true);
                    const fetchedBannedUsers = [];
                    for (const docSnap of snapshot.docs) {
                        const banData = docSnap.data();
                        const bannedUserId = docSnap.id;

                        // Fetch user profile for display details
                        const userProfileRef = doc(db, `artifacts/${appId}/users/${bannedUserId}/userProfiles`, bannedUserId);
                        try {
                            const profileSnap = await getDoc(userProfileRef);
                            fetchedBannedUsers.push({
                                id: bannedUserId,
                                ...banData,
                                ...(profileSnap.exists() ? profileSnap.data() : { displayUsername: bannedUserId, displayName: bannedUserId, profilePictureUrl: '', profileDecorationUrl: '', profileDecorationSize: 100 }), // Default decoration size
                                banUntil: banData.banUntil ? banData.banUntil.toDate() : null, // Convert Firestore Timestamp to Date object
                            });
                        } catch (error) {
                            console.error(`Error fetching profile for banned user ${bannedUserId}:`, error);
                            fetchedBannedUsers.push({
                                id: bannedUserId,
                                ...banData,
                                displayUsername: bannedUserId,
                                displayName: bannedUserId,
                                profilePictureUrl: '',
                                profileDecorationUrl: '', // Default decoration
                                profileDecorationSize: 100, // Default size
                                banUntil: banData.banUntil ? banData.banUntil.toDate() : null,
                            });
                        }
                    }
                    // Filter out expired bans and sort
                    const now = Date.now();
                    const activeBans = fetchedBannedUsers.filter(user => !user.banUntil || user.banUntil.getTime() > now);
                    activeBans.sort((a, b) => (a.displayName || a.displayUsername).localeCompare(b.displayName || b.displayUsername));
                    setBannedUsers(activeBans);
                    setIsLoading(false);

                    // Clean up expired bans from Firestore
                    fetchedBannedUsers.forEach(async (user) => {
                        if (user.banUntil && user.banUntil.getTime() <= now) {
                            try {
                                await deleteDoc(doc(db, `artifacts/${appId}/public/data/bannedUsers`, user.id));
                                console.log(`Cleaned up expired ban for user: ${user.id}`);
                            } catch (e) {
                                console.error(`Error cleaning up expired ban for ${user.id}:`, e);
                            }
                        }
                    });

                }, (error) => {
                    console.error("Error fetching banned users:", error);
                    setIsLoading(false);
                });

                return () => unsubscribe();
            }, [db, appId, isAdmin, currentUserId]); // Added currentUserId to dependencies to ensure re-fetch if admin status changes

            // Define dynamic decoration style for users in this modal
            const getDecorationStyle = (size) => ({
                position: 'absolute',
                width: `${size || 100}%`,
                height: `${size || 100}%`,
                top: '50%', // Center vertically
                left: '50%', // Center horizontally
                transform: 'translate(-50%, -50%)', // Adjust for element's own size
                objectFit: 'contain',
                zIndex: 20,
                pointerEvents: 'none',
            });

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className={`${currentTheme.chatBg} p-8 rounded-xl shadow-2xl w-full max-w-md h-[70vh] flex flex-col text-center`}>
                        <h2 className={`text-3xl font-bold mb-6 ${currentTheme.textColor} lowercase`}>banned users</h2>
                        {isLoading ? (
                            <p className={`${currentTheme.secondaryText}`}>loading banned users...</p>
                        ) : (
                            <div className={`flex-1 overflow-y-auto ${currentTheme.scrollbar}`} style={currentTheme.scrollbarVars}>
                                {bannedUsers.length === 0 ? (
                                    <p className={`${currentTheme.secondaryText} mt-8`}>no users are currently banned.</p>
                                ) : (
                                    bannedUsers.map(user => (
                                        <div key={user.id} className={`flex items-center p-3 rounded-lg shadow-sm lowercase ${currentTheme.otherBubbleBg}`}>
                                            <div className="relative w-8 h-8 flex-shrink-0 mr-3 overflow-visible"> {/* Container for PFP and decoration - Added overflow-visible */}
                                                <img
                                                    src={user.profilePictureUrl || 'https://placehold.co/32x32/cccccc/ffffff?text=P'}
                                                    alt="PFP"
                                                    className="w-full h-full rounded-full object-cover relative z-10"
                                                />
                                                {user.profileDecorationUrl && (
                                                    <img
                                                        src={user.profileDecorationUrl}
                                                        alt="Decoration"
                                                        style={getDecorationStyle(user.profileDecorationSize)}
                                                        onError={(e) => e.target.style.display='none'}
                                                    />
                                                )}
                                            </div>
                                            <div className="flex-1 text-left">
                                                <span
                                                    className={`font-semibold cursor-pointer hover:underline ${currentTheme.textColor}`}
                                                    onClick={() => onOpenUserProfile(user.id)}
                                                >
                                                    {user.displayName || user.displayUsername}
                                                </span>
                                                <p className={`${currentTheme.secondaryText} text-xs`}>
                                                    reason: {user.reason || 'not specified'}
                                                </p>
                                                {user.banUntil && (
                                                    <p className={`${currentTheme.secondaryText} text-xs`}>
                                                        until: {user.banUntil.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                                    </p>
                                                )}
                                            </div>
                                            {isAdmin && (
                                                <button
                                                    onClick={() => promptRevertBan(user)}
                                                    className="bg-green-500 text-white px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-600 transition duration-200 lowercase ml-auto"
                                                    title="Revert Ban"
                                                >
                                                    revert
                                                </button>
                                            )}
                                        </div>
                                    ))
                                )}
                            </div>
                        )}
                        <button
                            onClick={onClose}
                            className={`w-full mt-6 ${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} p-3 rounded-lg font-semibold ${currentTheme.buttonTertiaryHover} transition duration-300 lowercase`}
                        >
                            close
                        </button>
                    </div>
                </div>
            );
        };

        // NEW: InfoIconModal Component
        const InfoIconModal = ({ title, message, imageUrl, currentTheme, onClose }) => {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className={`${currentTheme.chatBg} p-8 rounded-xl shadow-2xl w-full max-w-md text-center`}>
                        <h2 className={`text-2xl font-bold mb-6 ${currentTheme.textColor} lowercase`}>{title}</h2>
                        <p className={`${currentTheme.textColor} mb-4 lowercase text-left`}>{message}</p>
                        {imageUrl && (
                            <img src={imageUrl} alt="Information example" className="w-full h-auto rounded-lg mb-6 object-cover" />
                        )}
                        <button
                            onClick={onClose}
                            className={`w-full ${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} p-3 rounded-lg font-semibold ${currentTheme.buttonTertiaryHover} transition duration-300 lowercase`}
                        >
                            got it
                        </button>
                    </div>
                </div>
            );
        };

        // NEW: ChangelogModal Component
        const ChangelogModal = ({ currentTheme, onClose }) => {
            const changes = [
                {
                    title: "Application Initialization and Core Functionality",
                    description: "Introduced foundational chatroom features, including user authentication via anonymous Firebase sessions, basic message sending and display, and a simplified room selection interface. User data persistence was implemented using local storage.",
                },
                {
                    title: "Enhanced User Management and Theming",
                    description: "Implemented comprehensive user authentication with email/password registration and login, replacing anonymous access. Private user profiles were integrated with Firestore for robust data management, including display names, profile pictures, and personal biographies. Direct messaging capabilities were added, allowing private conversations between users. Administrative controls were introduced, enabling message deletion on hover, user kicking from rooms, and global banning. A flexible custom theming system was developed, allowing users to personalize chat bubble colors and general UI aesthetics, with support for theme presets. Global announcements and active user tracking were also incorporated.",
                },
                {
                    title: "Advanced Customization and User Experience Refinements",
                    description: "Further expanded theme customization options to include distinct color pickers for primary and secondary UI text, and primary and secondary UI background elements, offering granular control over the application's appearance. The 'Chat UI Background Color' section was renamed to 'Chat UI' for clarity. The custom theme's accent color now dynamically influences the scrollbar's visual style. Informational icons have been added next to URL input fields, providing helpful guidance on image URL usage. A dedicated 'Changelog' feature has been added, offering a transparent overview of application updates and enhancements.",
                },
            ];

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className={`${currentTheme.chatBg} p-8 rounded-xl shadow-2xl w-full max-w-2xl h-[80vh] flex flex-col text-left overflow-y-auto ${currentTheme.scrollbar}`} style={currentTheme.scrollbarVars}>
                        <h2 className={`text-3xl font-bold mb-6 ${currentTheme.textColor} lowercase text-center`}>changelog</h2>
                        <div className="flex-1 space-y-6">
                            {changes.map((change, index) => (
                                <div key={index} className="p-4 bg-stone-100 rounded-lg shadow-sm">
                                    <h3 className={`text-xl font-bold ${currentTheme.textColor} mb-2 lowercase`}>{change.title}</h3>
                                    <p className={`${currentTheme.secondaryText} text-sm lowercase`}>{change.description}</p>
                                </div>
                            ))}
                        </div>
                        <button
                            onClick={onClose}
                            className={`w-full mt-6 ${currentTheme.buttonTertiaryBg} ${currentTheme.buttonTertiaryText} p-3 rounded-lg font-semibold ${currentTheme.buttonTertiaryHover} transition duration-300 lowercase`}
                        >
                            close
                        </button>
                    </div>
                </div>
            );
        };


        // render the react app to the root element
        ReactDOM.render(React.createElement(App), document.getElementById('root'));
    </script>
</body>
</html>